<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>사랑방 띵곡 플레이어</title>
  <style>
    body { font-family: system-ui, -apple-apple-system, Segoe UI, Roboto, sans-serif; background:#111; color:#eee; margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh;}
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; width:100%;}
    .card { border:1px solid #444; border-radius:10px; padding:16px; margin:12px 0; background:#222;}
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .btn { background:#63b3ed; color:#fff; border:0; border-radius:999px; padding:.6rem 1rem; cursor:pointer; transition:background .2s;}
    .btn:hover { background:#4299e1;}
    .btn:disabled { background:#4a5568; cursor:not-allowed;}
    .btn-toggle { background:#555;}
    .btn-toggle.active { background:#fc8181;}
    .btn-sort { background:#555; color:#fff;}
    .btn-sort.most-liked { background:#f6ad55;} /* 노랑: 따봉많은순 */
    .btn-sort.user-liked { background:#48bb78;} /* 초록: 내따봉우선 */

    .muted { color:#a0aec0;}
    input { background:#1f2937; color:#eee; border:1px solid #374151; border-radius:8px; padding:.55rem .7rem; flex:1; min-width:220px; outline:none;}
    input:focus { border-color:#63b3ed;}
    .item { display:flex; justify-content:space-between; align-items:center; padding:.5rem .6rem; border-bottom:1px solid #2f3743; cursor:pointer;}
    .item:hover { background:#2a3340;}
    .item:last-child { border-bottom:none;}
    .item .delete-btn { background:none; border:none; color:#fc8181; cursor:pointer; font-size:1.2em; line-height:1; margin-left:10px; opacity:.7;}
    .item .delete-btn:hover { opacity:1;}
    .item .info-icon { background:none; border:none; color:#63b3ed; cursor:pointer; font-size:1.2em; margin-right:5px;}
    .item .like-btn { background:none; border:none; cursor:pointer; font-size:1.2em; margin-right:5px; }
    .like-count { font-size:.9em; color:#a0aec0; margin-left:-5px; margin-right:5px;}
    .uploader-btn { background:none; border:none; color:#63b3ed; cursor:pointer; font-size:.9em; margin-right:5px; padding:0;}
    .video-player { aspect-ratio:16/9; width:100%; max-width:800px; margin:8px auto; border-radius:8px; overflow:hidden; position:relative;}
    .main-title { text-align:center;}
    .sub-title { text-align:center; font-size:.9em; margin-top:-15px; color:#a0aec0;}
    .message-box { display:none; background:#2d3748; color:#fff; padding:12px; border-radius:8px; text-align:center; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:1000;}
    #player { height:100%; width:100%;}
    .player-controls { display:none;}
    .modal { display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center;}
    .modal-content { background-color:#222; padding:20px; border:1px solid #444; width:80%; max-width:500px; border-radius:10px; position:relative;}
    .modal-content .modal-section { margin-bottom:15px;}
    .modal-content .modal-section label { display:block; margin-bottom:5px; font-weight:bold;}
    .modal-content input[type="text"], .modal-content textarea { width:100%; box-sizing:border-box; background:#1f2937; color:#eee; border:1px solid #374151; border-radius:8px; padding:10px;}
    .modal-content textarea { height:100px; resize:vertical;}
    .modal-content .close-btn { color:#aaa; float:right; font-size:28px; font-weight:bold;}
    .modal-content .close-btn:hover, .modal-content .close-btn:focus { color:#fff; cursor:pointer;}
    .modal-content .save-btn { background:#38b2ac; color:#fff; border:0; border-radius:999px; padding:.6rem 1rem; margin-top:10px; cursor:pointer;}
    .confirm-modal { display:none; position:fixed; z-index:1002; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); justify-content:center; align-items:center;}
    .confirm-modal-content { background-color:#222; padding:20px; border:1px solid #444; width:80%; max-width:350px; border-radius:10px; text-align:center;}
    .confirm-modal-buttons { display:flex; justify-content:space-around;}
    #currentSongNotes { border-top:1px solid #444; margin-top:10px; padding-top:10px;}
    #currentSongNotes p { margin:0 0 10px 0; color:#ccc;}
    .song-details { flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; display:flex; align-items:center;}
    .song-info-container { display:flex; align-items:center; justify-content:center; margin-top:10px; gap:10px; font-size:1.2em; font-weight:bold; text-align:center;}
    .song-info-text { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:calc(100% - 120px); display:flex; align-items:center; justify-content:center;}
    .current-info-btn { background:none; border:none; color:#63b3ed; cursor:pointer; font-size:1.2em; margin-right:5px; padding:0; width:40px; height:40px; display:flex; justify-content:center; align-items:center;}
    .new-tag { background-color:#f6ad55; color:#fff; font-size:.7em; font-weight:bold; padding:2px 6px; border-radius:999px; margin-left:8px; vertical-align:middle; text-transform:uppercase;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<audio id="dingdong-sound" src="https://cdn.pixabay.com/audio/2021/08/04/audio_33e07f59d5.mp3" preload="auto" volume="0.3"></audio>
<div id="message-box" class="message-box"></div>
<div class="wrap">
  <div class="main-title">
    <h1>사랑방 띵곡 플레이어</h1>
    <p class="sub-title">작가님들의 띵곡을 추천해주세요</p>
  </div>

  <div class="card">
    <div id="player-container" class="video-player">
      <div id="player"></div>
      <div class="player-controls">
        <button id="prev-song-btn" class="prev">&lt;</button>
        <button id="next-song-btn" class="next">&gt;</button>
      </div>
    </div>

    <div class="song-info-container">
      <button id="prev-song-btn-inline" class="btn">&lt;</button>
      <div id="currentSongInfo" class="song-info-text">
        <span class="muted">현재 재생 중인 곡이 없습니다.</span>
      </div>
      <button id="next-song-btn-inline" class="btn">&gt;</button>
    </div>

    <div id="currentSongNotes"><span class="muted"></span></div>

    <div class="row" style="margin-top:10px">
      <input id="url" placeholder="유튜브 링크 또는 노래 제목을 입력"/>
      <button id="add" class="btn">추가</button>
      <button id="shuffleBtn" class="btn btn-toggle">셔플</button>
      <button id="likeSortBtn" class="btn btn-sort">따봉 정렬</button>
      <button id="togglePlayerBtn" class="btn btn-toggle">화면 숨기기</button>
    </div>

    <div id="manual-input" style="display:none; margin-top: 10px;">
      <div class="row"><input id="manualTitle" placeholder="제목을 수동으로 입력해주세요"/></div>
      <div class="row" style="margin-top: 10px;"><input id="manualArtist" placeholder="아티스트를 수동으로 입력해주세요"/></div>
    </div>

    <div id="playlist" class="card" style="margin:10px 0 0 0">
      <div class="muted">재생목록이 비어있습니다.</div>
    </div>
  </div>
</div>

<!-- Info Modal -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>노래 정보</h3>
    <div class="modal-section">
      <label for="songTitleInput">노래 제목</label>
      <input type="text" id="songTitleInput" placeholder="노래 제목을 입력하세요..."/>
    </div>
    <div class="modal-section">
      <label for="artistInput">아티스트</label>
      <input type="text" id="artistInput" placeholder="아티스트 이름을 입력하세요..."/>
    </div>
    <div class="modal-section">
      <label for="uploaderInput">올린 사람</label>
      <input type="text" id="uploaderInput" placeholder="이름을 입력하세요..."/>
    </div>
    <div class="modal-section">
      <label for="infoTextarea">노래에 대한 정보</label>
      <textarea id="infoTextarea" placeholder="노트에 메모를 입력하세요..."></textarea>
    </div>
    <div class="modal-section">
      <label for="commentTextarea">댓글</label>
      <textarea id="commentTextarea" placeholder="댓글을 입력하세요..."></textarea>
    </div>
    <button id="saveInfoBtn" class="save-btn">저장</button>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="confirm-modal">
  <div class="confirm-modal-content">
    <p>정말로 삭제하시겠습니까?</p>
    <div class="confirm-modal-buttons">
      <button id="confirmYes" class="btn">예</button>
      <button id="confirmNo" class="btn btn-toggle">아니오</button>
    </div>
  </div>
</div>

<script>
  // ---- Firebase/환경 ----
  const __firebase_config='{"apiKey":"AIzaSyDz6xGJNKXinG5rREjdrPz7toIYGZXzilU","authDomain":"sarangbangmusicplaylist.firebaseapp.com","projectId":"sarangbangmusicplaylist","storageBucket":"sarangbangmusicplaylist.appspot.com","messagingSenderId":"193412502606","appId":"1:193412502606:web:0f7f9ddbef1ee6711d1ff","measurementId":"G-L14GH3BHYD"}';
  const __app_id="default-app-id";
  const __initial_auth_token="";
  const firebaseConfig=JSON.parse(__firebase_config);
  const YOUTUBE_API_KEY="AIzaSyB2GymrywkBYx4Mbt_xHNiYEV44MbfKY2w";

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  let userId=null, authed=false, db, player, isYoutubeApiReady=false;
  let isManuallyAdding=false;

  // ---- DOM ----
  const urlInput=document.getElementById('url');
  const addBtn=document.getElementById('add');
  const shuffleBtn=document.getElementById('shuffleBtn');
  const likeSortBtn=document.getElementById('likeSortBtn');
  const listEl=document.getElementById('playlist');
  const messageBox=document.getElementById('message-box');
  const manualInputDiv=document.getElementById('manual-input');
  const manualTitleInput=document.getElementById('manualTitle');
  const manualArtistInput=document.getElementById('manualArtist');
  const prevSongBtn=document.getElementById('prev-song-btn-inline');
  const nextSongBtn=document.getElementById('next-song-btn-inline');
  const currentSongNotesEl=document.getElementById('currentSongNotes');
  const togglePlayerBtn=document.getElementById('togglePlayerBtn');
  const playerContainer=document.getElementById('player-container');

  const infoModal=document.getElementById('infoModal');
  const songTitleInput=document.getElementById('songTitleInput');
  const artistInput=document.getElementById('artistInput');
  const uploaderInput=document.getElementById('uploaderInput');
  const infoTextarea=document.getElementById('infoTextarea');
  const commentTextarea=document.getElementById('commentTextarea');
  const saveInfoBtn=document.getElementById('saveInfoBtn');
  const modalCloseBtn=document.querySelector('.modal .close-btn');

  const confirmModal=document.getElementById('confirmModal');
  const confirmYesBtn=document.getElementById('confirmYes');
  const confirmNoBtn=document.getElementById('confirmNo');

  const globalState={
    playlist:[],
    songLikes:{},     // {videoId:{likeCount, likedBy:{uid:true}}}
    notes:{},
    isShuffleMode:false,
    likeSortMode:0,   // 0 최신, 1 따봉많은순, 2 내따봉우선
    videoId:'',
    currentPlayingIndex:-1,
    shuffledDeck:[],  // 다음에 나올 videoId 큐
    playbackTitle:null,
    playbackArtist:null,
  };

  // ---- YouTube Iframe API ----
  window.onYouTubeIframeAPIReady=function(){
    isYoutubeApiReady=true;
    player=new YT.Player('player',{height:'100%',width:'100%',videoId:'',playerVars:{autoplay:1,controls:1},events:{onStateChange:onPlayerStateChange}});
  };
  function onPlayerStateChange(e){ if(e.data===YT.PlayerState.ENDED) playNext(); }

  // ---- Utils ----
  function showMessage(msg,type='info'){
    messageBox.textContent=msg;
    messageBox.style.background=(type==='error')?'#fc8181':'#2d3748';
    messageBox.style.display='block';
    setTimeout(()=>{messageBox.style.display='none';},1500);
  }
  function showConfirm(message){
    document.querySelector('#confirmModal p').textContent=message;
    confirmModal.style.display='flex';
    return new Promise((resolve)=>{
      confirmYesBtn.onclick=()=>{confirmModal.style.display='none'; resolve(true);};
      confirmNoBtn.onclick=()=>{confirmModal.style.display='none'; resolve(false);};
    });
  }
  function isNew(item){
    const t=item?.createdAt?.toDate?item.createdAt.toDate().getTime():item?.createdAt?.getTime?.();
    if(!t) return false; return (Date.now()-t) < 12*60*60*1000;
  }
  function isLiked(videoId){
    return !!globalState.songLikes[videoId]?.likedBy?.[userId];
  }

  // ---- Boot ----
  async function boot(){
    try{ firebase.initializeApp(firebaseConfig); db=firebase.firestore(); } catch(e){ console.error(e); return; }
    try{
      const auth=firebase.auth();
      const cred=(typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
        ? await auth.signInWithCustomToken(__initial_auth_token)
        : await auth.signInAnonymously();
      userId=cred.user.uid; authed=true;
    }catch(e){ console.error(e); return; }

    startRealtime();
    wireUI();
  }

  function startRealtime(){
    // playlist
    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('playlist_state').doc('main_playlist')
      .onSnapshot(snap=>{
        if(!snap.exists) return;
        const data=snap.data()||{};
        globalState.playlist = Array.isArray(data.playlist)?data.playlist:[];
        renderList();
        if(globalState.isShuffleMode) rebuildShuffleDeck(); // 최신 상태로 재구성
      });

    // notes
    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes')
      .onSnapshot(ss=>{
        const m={}; ss.docs.forEach(d=>{ m[d.id]=d.data(); });
        globalState.notes=m; renderList();
      });

    // likes
    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('song_likes')
      .onSnapshot(ss=>{
        const m={}; ss.docs.forEach(d=>{ m[d.id]=d.data(); });
        globalState.songLikes=m; renderList();
        if(globalState.isShuffleMode) syncDeckWithMode();
      });
  }

  // ---- Sorting / Visible list ----
  function getVisibleList(){
    let list=[...globalState.playlist];
    // 기본 최신
    list.sort((a,b)=>{
      const ta=a.createdAt?.toDate?a.createdAt.toDate().getTime():a.createdAt?.getTime();
      const tb=b.createdAt?.toDate?b.createdAt.toDate().getTime():b.createdAt?.getTime();
      return (tb||0)-(ta||0);
    });

    if(globalState.likeSortMode===1){
      list.sort((a,b)=>{
        const la=globalState.songLikes[a.videoId]?.likeCount||0;
        const lb=globalState.songLikes[b.videoId]?.likeCount||0;
        return lb-la;
      });
    } else if(globalState.likeSortMode===2){
      const liked=[], others=[];
      list.forEach(it=> (isLiked(it.videoId)?liked:others).push(it));
      list=[...liked,...others];
    }
    return list;
  }

  // ---- Shuffle deck (likeSortMode===2이면 내가 좋아요한 곡만) ----
  function shuffleArray(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
  function getShuffleSourceIds(){
    const vis = getVisibleList().map(s=>s.videoId);
    if(globalState.likeSortMode===2){
      const likedOnly = vis.filter(id=>isLiked(id));
      return likedOnly;
    }
    return vis;
  }
  function rebuildShuffleDeck(){
    const src = getShuffleSourceIds().filter(id=>id!==globalState.videoId);
    globalState.shuffledDeck = shuffleArray(src);
  }
  function syncDeckWithMode(){
    const pool = new Set(getShuffleSourceIds());
    globalState.shuffledDeck = globalState.shuffledDeck.filter(id=> pool.has(id) && id!==globalState.videoId);
    // 누락된 후보 보강
    getShuffleSourceIds().forEach(id=>{
      if(id!==globalState.videoId && !globalState.shuffledDeck.includes(id)) globalState.shuffledDeck.push(id);
    });
  }

  // ---- Render ----
  function renderList(){
    listEl.innerHTML='';
    const list=getVisibleList();
    if(!list.length){ listEl.innerHTML='<div class="muted">재생목록이 비어있습니다.</div>'; renderCurrentSongInfo(); return; }

    list.forEach((item,index)=>{
      const div=document.createElement('div'); div.className='item'; div.dataset.videoId=item.videoId; div.dataset.index=index;

      const songDetails=document.createElement('div'); songDetails.className='song-details';
      const infoIcon=document.createElement('button'); infoIcon.className='info-icon'; infoIcon.innerHTML='&#x24D8;';
      infoIcon.addEventListener('click',(e)=>{ e.stopPropagation(); openInfoModal(item.videoId); });
      songDetails.appendChild(infoIcon);

      const titleSpan=document.createElement('span'); titleSpan.textContent=`${item.artist} - ${item.title}`; songDetails.appendChild(titleSpan);
      if(isNew(item)){ const tag=document.createElement('span'); tag.className='new-tag'; tag.textContent='new'; titleSpan.prepend(tag,' '); }

      const likeWrapper=document.createElement('div');

      const likeBtn=document.createElement('button');
      likeBtn.className='like-btn';
      const mine = isLiked(item.videoId);
      likeBtn.setAttribute('aria-pressed', mine?'true':'false');
      likeBtn.textContent = mine ? '👍' : '👍🏿';
      likeBtn.addEventListener('click',(e)=>{ e.stopPropagation(); handleLike(item.videoId); });

      const countSpan=document.createElement('span'); countSpan.className='like-count';
      countSpan.textContent=globalState.songLikes[item.videoId]?.likeCount||0;

      const delBtn=document.createElement('button'); delBtn.className='delete-btn'; delBtn.innerHTML='&#x2715;';
      delBtn.addEventListener('click', async (e)=>{ e.stopPropagation(); const ok=await showConfirm("정말로 삭제하시겠습니까?"); if(ok){ const np=[...globalState.playlist].filter(s=>s.videoId!==item.videoId); updatePlaylist(np); } });

      likeWrapper.appendChild(likeBtn);
      likeWrapper.appendChild(countSpan);

      div.appendChild(songDetails);
      div.appendChild(likeWrapper);
      div.appendChild(delBtn);

      div.addEventListener('click',()=>{
        const active=getVisibleList(); const idx=active.findIndex(s=>s.videoId===item.videoId);
        if(idx!==-1){ playVideo(idx); showMessage("해당 곡을 재생합니다."); }
      });

      listEl.appendChild(div);
    });

    const list2=getVisibleList();
    const inList=list2.some(i=>i.videoId===globalState.videoId);
    if(globalState.videoId && !inList && list2.length>0){
      let nextIndex=globalState.currentPlayingIndex; if(nextIndex>=list2.length) nextIndex=list2.length-1; playVideo(nextIndex);
    } else if(list2.length>0 && globalState.currentPlayingIndex===-1){
      playVideo(0);
    }
    renderCurrentSongInfo();
  }

  function renderCurrentSongInfo(){
    const visible=getVisibleList();
    const song=visible.find(s=>s.videoId===globalState.videoId);
    const el=document.getElementById('currentSongInfo');
    if(song){
      const btn=`<button class="current-info-btn" onclick="openInfoModal('${song.videoId}')">&#x24D8;</button>`;
      el.innerHTML = btn + `<span style="font-weight:bold;">${song.title}</span><span class="muted" style="margin-left:5px;"> - ${song.artist}</span>`;
    }else if(globalState.videoId && (globalState.playbackTitle||globalState.playbackArtist)){
      const t=globalState.playbackTitle||'제목 미상'; const a=globalState.playbackArtist||'아티스트 미상';
      const btn=`<button class="current-info-btn" onclick="openInfoModal('${globalState.videoId}')">&#x24D8;</button>`;
      el.innerHTML = btn + `<span style="font-weight:bold;">${t}</span><span class="muted" style="margin-left:5px;"> - ${a}</span>`;
    }else{
      el.innerHTML='<span class="muted">현재 재생 중인 곡이 없습니다.</span>';
    }
    renderCurrentSongNotes();
  }

  async function renderCurrentSongNotes(){
    const el=currentSongNotesEl;
    el.innerHTML='<span class="muted">정보를 불러오는 중...</span>';
    const videoId=globalState.videoId;
    if(!videoId || !authed){ el.innerHTML='<span class="muted">작성된 정보가 없습니다.</span>'; return; }
    const ref=db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes').doc(videoId);
    try{
      const snap=await ref.get();
      if(snap.exists){
        const d=snap.data();
        el.innerHTML=`<p><strong>올린 사람:</strong> ${d.uploader||'알 수 없음'}</p><p><strong>노래 정보:</strong> ${d.info||'작성된 정보가 없습니다.'}</p><p><strong>댓글:</strong> ${d.comment||'작성된 댓글이 없습니다.'}</p>`;
      }else{
        el.innerHTML='<span class="muted">작성된 정보가 없습니다.</span>';
      }
    }catch(e){ el.innerHTML='<span class="muted">정보를 불러오는 데 실패했습니다.</span>'; }
  }

  // ---- Playlist update ----
  let playlistSaveTimer=null;
  function updatePlaylist(newPlaylist){
    globalState.playlist=newPlaylist;
    if(!authed) return;
    if(playlistSaveTimer) clearTimeout(playlistSaveTimer);
    playlistSaveTimer=setTimeout(async()=>{
      try{
        const ref=db.collection('artifacts').doc(appId).collection('public').doc('data').collection('playlist_state').doc('main_playlist');
        const valid=newPlaylist.map(it=>({...it, createdAt: it.createdAt || new Date()}));
        await ref.set({playlist:valid, updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      }catch(e){ console.error(e); }
    },200);
  }

  // ---- Like toggle (DB만) ----
  async function handleLike(videoId){
    if(!userId){ showMessage("로그인되지 않았습니다.",'error'); return; }
    const docRef=db.collection('artifacts').doc(appId).collection('public').doc('data').collection('song_likes').doc(videoId);
    try{
      await db.runTransaction(async(tr)=>{
        const snap=await tr.get(docRef);
        let likeCount=0, likedBy={};
        if(snap.exists){ likeCount=snap.data().likeCount||0; likedBy=snap.data().likedBy||{}; }
        const mine=!!likedBy[userId];
        if(mine){ likeCount=Math.max(0, likeCount-1); delete likedBy[userId]; showMessage("좋아요 취소"); }
        else { likeCount++; likedBy[userId]=true; showMessage("좋아요 👍"); }
        tr.set(docRef,{likeCount, likedBy, lastUpdated:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      });
      // 즉시감각을 위해 재렌더
      renderList();
      if(globalState.isShuffleMode) syncDeckWithMode();
    }catch(e){ console.error(e); showMessage("좋아요 실패: "+e.message,'error'); }
  }

  // ---- Player ----
  function playVideo(index){
    const list=getVisibleList(); if(!list.length) return;
    const i=Math.max(0, Math.min(index, list.length-1));
    const song=list[i];
    if(song && song.videoId && isYoutubeApiReady){
      player.loadVideoById(song.videoId);
      globalState.videoId=song.videoId;
      globalState.currentPlayingIndex=i;
      globalState.playbackTitle=song.title;
      globalState.playbackArtist=song.artist;
      // 현재 곡은 덱에서 제거
      globalState.shuffledDeck = globalState.shuffledDeck.filter(id=>id!==song.videoId);
      renderCurrentSongInfo();
    }
  }
  function playNext(){
    if(globalState.isShuffleMode){
      if(globalState.shuffledDeck.length===0){
        rebuildShuffleDeck();
        if(globalState.shuffledDeck.length===0){ showMessage("셔플할 곡이 없습니다.",'error'); return; }
      }
      const nextId=globalState.shuffledDeck.shift();
      const meta=getVisibleList().find(s=>s.videoId===nextId);
      if(isYoutubeApiReady) player.loadVideoById(nextId);
      if(meta){ globalState.playbackTitle=meta.title; globalState.playbackArtist=meta.artist; }
      globalState.videoId=nextId;
      globalState.currentPlayingIndex=getVisibleList().findIndex(s=>s.videoId===nextId);
      renderCurrentSongInfo();
      return;
    }
    const list=getVisibleList(); if(!list.length) return;
    const idx=(globalState.currentPlayingIndex+1)%list.length; playVideo(idx);
  }
  function playPrev(){
    if(globalState.isShuffleMode){ showMessage("셔플 모드에서 이전 곡은 지원하지 않습니다.",'error'); return; }
    const list=getVisibleList(); if(!list.length) return;
    const idx=(globalState.currentPlayingIndex-1+list.length)%list.length; playVideo(idx);
  }

  // ---- Info modal ----
  function openInfoModal(videoId){
    const item=globalState.playlist.find(i=>i.videoId===videoId);
    songTitleInput.value=item?.title||globalState.playbackTitle||'';
    artistInput.value=item?.artist||globalState.playbackArtist||'';
    const ref=db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes').doc(videoId);
    ref.get().then(s=>{
      if(s.exists){ const d=s.data(); uploaderInput.value=d.uploader||''; infoTextarea.value=d.info||''; commentTextarea.value=d.comment||''; }
      else{ uploaderInput.value=''; infoTextarea.value=''; commentTextarea.value=''; }
    });
    infoModal.style.display='flex'; window.currentInfoVideoId=videoId;
  }
  function closeInfoModal(){ infoModal.style.display='none'; window.currentInfoVideoId=null; }
  async function saveInfo(){
    const id=window.currentInfoVideoId; if(!id || !authed) return;
    const newTitle=songTitleInput.value.trim(); const newArtist=artistInput.value.trim();
    const np=[...globalState.playlist]; const idx=np.findIndex(i=>i.videoId===id);
    if(idx!==-1){ np[idx].title=newTitle; np[idx].artist=newArtist; updatePlaylist(np); }
    const ref=db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes').doc(id);
    await ref.set({uploader:uploaderInput.value.trim(), info:infoTextarea.value.trim(), comment:commentTextarea.value.trim(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    closeInfoModal(); showMessage("노트 저장");
  }

  // ---- Add/search ----
  async function fetchVideoDetails(videoId){
    const apiUrl=`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
    const r=await fetch(apiUrl); if(!r.ok) throw new Error(`API ${r.status}`);
    const d=await r.json(); if(d.items?.length){ const s=d.items[0].snippet; return {title:s.title, artist:s.channelTitle}; }
    throw new Error("동영상 정보를 찾을 수 없음");
  }
  function getVideoId(url){
    if(url.length===11 && !url.includes(' ')) return url;
    url=url.replace('music.youtube.com','www.youtube.com');
    const re=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
    const m=url.match(re); return m&&m[1]?m[1]:null;
  }
  async function searchYouTubeAndAddSong(query){
    if(!query){ showMessage("검색어를 입력하세요",'error'); return; }
    const apiUrl=`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=1&key=${YOUTUBE_API_KEY}`;
    const r=await fetch(apiUrl); if(!r.ok) throw new Error(`API ${r.status}`);
    const d=await r.json();
    if(d.items?.length){
      const it=d.items[0]; const videoId=it.id.videoId; const title=it.snippet.title; const artist=it.snippet.channelTitle;
      const np=[...globalState.playlist, {title, artist, videoId, createdAt:new Date()}]; updatePlaylist(np); urlInput.value=''; showMessage('추가 완료');
    } else { throw new Error("검색 결과 없음"); }
  }

  // ---- Wire UI ----
  function wireUI(){
    addBtn.addEventListener('click', async ()=>{
      const val=urlInput.value.trim();
      addBtn.disabled=true; addBtn.textContent='불러오는 중...';
      try{
        const videoId=getVideoId(val);
        if(videoId){
          const v=await fetchVideoDetails(videoId);
          const np=[...globalState.playlist, {title:v.title, artist:v.artist, videoId, createdAt:new Date()}];
          updatePlaylist(np); urlInput.value=''; showMessage('추가 완료');
        } else {
          await searchYouTubeAndAddSong(val);
        }
      }catch(e){
        showMessage("실패: 수동 입력으로 전환",'error');
        isManuallyAdding=true; manualInputDiv.style.display='block'; addBtn.textContent='수동 추가';
      } finally { addBtn.disabled=false; addBtn.textContent='추가'; }
    });

    // 수동 추가
    addBtn.addEventListener('click', async ()=>{
      if(!isManuallyAdding) return;
      const val=urlInput.value.trim(); const vid=getVideoId(val);
      const t=manualTitleInput.value.trim(); const a=manualArtistInput.value.trim();
      if(!vid){ showMessage("유효한 링크/ID 필요",'error'); return; }
      if(!t||!a){ showMessage("제목/아티스트 입력",'error'); return; }
      const np=[...globalState.playlist, {title:t, artist:a, videoId:vid, createdAt:new Date()}];
      updatePlaylist(np); urlInput.value=''; manualTitleInput.value=''; manualArtistInput.value='';
      isManuallyAdding=false; manualInputDiv.style.display='none'; showMessage('추가 완료');
    }, { once:false });

    // 셔플
    shuffleBtn.addEventListener('click', ()=>{
      globalState.isShuffleMode=!globalState.isShuffleMode;
      shuffleBtn.classList.toggle('active', globalState.isShuffleMode);
      if(globalState.isShuffleMode){
        rebuildShuffleDeck();
        if(globalState.likeSortMode===2 && globalState.shuffledDeck.length===0){
          showMessage("내가 좋아요한 곡이 없습니다.",'error');
          globalState.isShuffleMode=false;
          shuffleBtn.classList.remove('active');
        } else {
          showMessage(globalState.likeSortMode===2?"내 좋아요만 셔플":"전체 셔플");
        }
      } else {
        showMessage("셔플 해제");
      }
    });

    // 따봉 정렬 3단계. 셔플 유지. 덱은 모드에 맞춰 재구성.
    likeSortBtn.addEventListener('click', ()=>{
      globalState.likeSortMode=(globalState.likeSortMode+1)%3;
      likeSortBtn.classList.remove('most-liked','user-liked');
      if(globalState.likeSortMode===1){ likeSortBtn.classList.add('most-liked'); showMessage("따봉 많은 순"); }
      else if(globalState.likeSortMode===2){ likeSortBtn.classList.add('user-liked'); showMessage("내 따봉 우선"); }
      else { showMessage("최신순"); }
      renderList();
      if(globalState.isShuffleMode){
        rebuildShuffleDeck();
        if(globalState.likeSortMode===2 && globalState.shuffledDeck.length===0){
          showMessage("내가 좋아요한 곡이 없습니다.",'error');
          globalState.isShuffleMode=false;
          shuffleBtn.classList.remove('active');
        }
      }
    });

    document.getElementById('prev-song-btn-inline').addEventListener('click', ()=>{ playPrev(); });
    document.getElementById('next-song-btn-inline').addEventListener('click', ()=>{ playNext(); });

    togglePlayerBtn.addEventListener('click', ()=>{
      const vis = playerContainer.style.opacity!=='0';
      if(vis){ playerContainer.style.height='0'; playerContainer.style.opacity='0'; togglePlayerBtn.classList.add('active'); }
      else { playerContainer.style.height='auto'; playerContainer.style.opacity='1'; togglePlayerBtn.classList.remove('active'); }
    });

    modalCloseBtn.addEventListener('click', ()=>{ infoModal.style.display='none'; });
    saveInfoBtn.addEventListener('click', saveInfo);
    window.addEventListener('click', (e)=>{ if(e.target===infoModal) infoModal.style.display='none'; });
  }

  // expose
  window.openInfoModal=openInfoModal;

  // start
  window.onload=boot;
</script>
</body>
</html>
