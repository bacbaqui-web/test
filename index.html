<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- 1. 제목 수정 -->
  <title>제2회 네컷만화대전</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem;
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    
    #comic-grid {
      column-count: 2; column-gap: 1rem; margin-top: 1.5rem; display: block;
    }
    @media (min-width: 640px) { #comic-grid { column-count: 3; } }
    @media (min-width: 1024px) { #comic-grid { column-count: 4; } }
    @media (min-width: 1280px) { #comic-grid { column-count: 5; } }

    .comic-card {
      position: relative; transition: transform .2s ease-in-out; 
      background: #333; border-radius: 12px; 
      overflow: hidden; margin-bottom: 1rem; 
      break-inside: avoid; width: 100%;
      display: block; cursor: pointer;
    }
    .comic-card:hover { transform: translateY(-5px); background: #444; }
    
    .comic-card .content {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; width: 100%; min-height: 120px; 
      padding: 16px; text-align: center;
      background-color: #1a1a1a; position: relative;
    }
    
    .comic-card .nickname-display {
      font-size: 1.25rem; font-weight: 700; color: #fff; word-break: break-all;
    }
    .comic-card .sub-text { font-size: 0.8rem; color: #aaa; margin-top: 4px; }
    
    /* 2. 제시어 표시 스타일 */
    .comic-card .topic-display {
      font-size: 0.9rem; font-weight: 700; color: #34d399; /* emerald-400 */
      margin-top: 8px;
      padding: 4px 8px;
      background-color: rgba(52, 211, 153, 0.1);
      border: 1px solid rgba(52, 211, 153, 0.3);
      border-radius: 6px;
    }

    .comic-card img { display: none; }

    .comic-card .info-footer { padding: 12px; background: #333; text-align: left; }
    .comic-card .uploader-name { font-size: 0.8rem; color: #ccc; margin-bottom: 8px; font-weight: 700; }
    .comic-card .like-section { display: flex; justify-content: space-between; align-items: center; }

    .like-btn {
      display: flex; align-items: center; gap: 6px;
      background: #555; color: white; padding: 6px 10px;
      border-radius: 20px; font-size: 0.9rem; font-weight: 700;
      transition: all 0.2s ease; cursor: pointer; border: none;
    }
    .like-btn.liked { background: #2563eb; color: white; }
    .like-btn:hover:not(.liked) { background: #666; }
    .like-count { font-size: 0.9rem; font-weight: 700; color: #ddd; }

    #imageModal.modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #imageModal .modal-content {
      background-color: #1a1a1a; padding: 1.5rem; 
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      border-radius: 12px; max-width: 90vw; max-height: 90vh;
      width: auto; height: auto; display: flex;
      flex-direction: column; justify-content: flex-start; 
      align-items: center; cursor: default; overflow-y: auto;
    }
    
    #modalComicNickname {
      font-size: 1.5rem; font-weight: 700; color: #fff;
      margin-bottom: 0.5rem; /* 간격 줄임 */
      width: 100%; text-align: center;
    }
    
    /* 3. 모달 제시어 스타일 */
    #modalComicTopic {
      font-size: 1.1rem; font-weight: 700; color: #34d399; /* emerald-400 */
      margin-bottom: 1rem; padding-bottom: 0.5rem;
      border-bottom: 2px solid #444;
      width: 100%; text-align: center;
    }

    #modalImageContainer {
      display: flex; flex-direction: column; gap: 10px;
      width: 100%; max-width: 500px;
    }
    #modalImageContainer img {
      width: 100%; height: auto; display: block; border-radius: 8px;
    }
    #modalImage { display: none; }
    
    /* 업로드 모달 */
    #uploadModal {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #uploadModal .modal-content {
      background: #2a2a2a; border-radius: 12px;
      padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.5);
      width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    }
    #imagePreviewArea {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
      margin-top: 1rem; padding: 10px; background: #1a1a1a;
      border-radius: 8px; min-height: 100px;
    }
    .preview-image {
      width: 100%; height: auto; object-fit: cover;
      border-radius: 4px; aspect-ratio: 1 / 1;
    }
    .file-input-label {
      background: #444; color: white; padding: 10px 15px;
      border-radius: 8px; cursor: pointer; text-align: center;
      font-weight: 700; transition: background .2s;
    }
    .file-input-label:hover { background: #555; }
    #comicFilesInput { display: none; }
    
    /* 4. 대전 시작 버튼 스타일 */
    #startContestBtn {
      background: #10b981; /* emerald-500 */
      color: white;
      font-weight: 700;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1.1rem;
      transition: all .2s ease;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
    }
    #startContestBtn:hover {
      background: #059669; /* emerald-600 */
      transform: translateY(-2px);
    }
    
    /* 5. 제시어 표시 영역 스타일 */
    #contestTopicDisplay {
      font-size: 1.25rem;
      font-weight: 700;
      color: #34d399; /* emerald-400 */
      margin-top: 0.5rem;
      padding: 8px 16px;
      background-color: rgba(52, 211, 153, 0.1);
      border: 2px solid rgba(52, 211, 153, 0.3);
      border-radius: 8px;
    }

    @media (max-width:768px){
      body{padding:12px;gap:0.5rem}.section-card{padding:12px;border-radius:0}
      #uploadModal .modal-content { width: 95%; padding: 16px; }
      #imagePreviewArea { grid-template-columns: repeat(2, 1fr); }
      #modalImageContainer { max-width: 100%; }
    }
  </style>
</head>
<body class="text-white">

  <!-- 로그인 바 (숨김 처리) -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2 mb-2 hidden">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <!-- 메인 타이틀 -->
  <h1 class="text-3xl font-bold text-center text-white">
    <span class="text-blue-400">제2회 네컷만화</span>
    <span class="text-white">대전</span>
    <span class="text-red-400">!</span>
  </h1>
  
  <!-- 6. 제시어 표시 영역 (초기 숨김) -->
  <div id="contestTopicDisplay" class="hidden">
    오늘의 제시어: <span id="contestTopicText" class="text-white">...</span>
  </div>
  
  <!-- 7. 대전 시작 버튼 -->
  <button id="startContestBtn" class="mt-2 mb-4">
    대전 시작하기
  </button>


  <!-- 만화 업로드 및 갤러리 섹션 -->
  <div id="comics-section" class="section-card text-left">
    
    <!-- 8. 업로드 버튼 (초기 숨김) -->
    <section class="text-center mb-6">
      <button id="showUploadModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105 hidden">
        + 네컷만화 올리기
      </button>
    </section>
    
    <!-- 네컷만화 갤러리 그리드 -->
    <section id="comic-grid"></section>
  </div>


  <!-- 이미지 확대 모달 -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <!-- 닉네임 표시 영역 -->
      <h3 id="modalComicNickname" class="text-xl font-bold text-white text-center"></h3>
      <!-- 9. 모달 제시어 표시 영역 -->
      <div id="modalComicTopic" class="hidden"></div>
      
      <!-- 이미지 컨테이너 (여러 이미지 표시용) -->
      <div id="modalImageContainer"></div>
      <img id="modalImage" src="" alt="확대 이미지" class="hidden" />
    </div>
  </div>

  <!-- 새 만화 업로드 모달 -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4">네컷만화 올리기</h2>
      
      <div class="mb-4">
        <label for="uploadNickname" class="block text-sm font-medium text-gray-300 mb-1">닉네임</label>
        <input type="text" id="uploadNickname" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="작가명을 입력하세요">
      </div>

      <div class="mb-4">
        <label for="comicFilesInput" class="file-input-label">
          만화 이미지 선택 (최대 4장)
        </label>
        <input type="file" id="comicFilesInput" multiple accept="image/*">
        <p class="text-xs text-gray-400 mt-2">팁: 1~4장의 이미지를 선택하세요. 4장이 넘으면 4장까지만 업로드됩니다.</p>
      </div>

      <div id="imagePreviewArea">
        <span class="text-gray-500 text-sm self-center justify-self-center col-span-2">이미지 미리보기</span>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button id="cancelUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">취소</button>
        <button id="submitComicBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">제출</button>
      </div>
    </div>
  </div>


  <!-- 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-lg text-center font-medium"></p>
      <div class="mt-4 flex justify-center gap-4">
        <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 hidden">취소</button>
        <button id="modal-confirm-btn" class="px-4 py-2 bg-[#424242] text-white rounded-md hover:bg-[#525252]">확인</button>
      </div>
    </div>
  </div>

  <!-- 10. 대전 시작 모달 (비밀번호) -->
  <div id="contestPasswordModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">대전 시작</h3>
      <p class="text-gray-300 text-center mb-4">관리자 비밀번호를 입력하세요.</p>
      <input type="password" id="contestPasswordInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelPasswordBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">취소</button>
        <button id="submitPasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">확인</button>
      </div>
    </div>
  </div>
  
  <!-- 11. 대전 시작 모달 (제시어) -->
  <div id="contestTopicModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">제시어 설정</h3>
      <p class="text-gray-300 text-center mb-4">오늘의 제시어를 입력하세요.</p>
      <input type="text" id="contestTopicInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="예: 우주, 라면, ...">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelTopicBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">취소</button>
        <button id="submitTopicBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">설정</button>
      </div>
    </div>
  </div>


  <!-- 로딩 오버레이 -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-4 text-lg">데이터를 불러오는 중...</p>
    </div>
  </div>

  <!-- ===== UI 스크립트 ===== -->
  <script>
    // ImgBB API Key (이미지 업로드용)
    const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

    // 전역 상태
    window.comics = [];
    window.isAuthReady = false;
    window.currentContestTopic = null; // 12. 현재 제시어 상태

    // DOM 요소
    const comicGrid = document.getElementById('comic-grid');
    const imageModal = document.getElementById('imageModal');
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalComicNickname = document.getElementById('modalComicNickname');
    const modalComicTopic = document.getElementById('modalComicTopic'); // 13. 모달 제시어 DOM
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');
    
    // 업로드 모달 DOM 요소
    const showUploadModalBtn = document.getElementById('showUploadModalBtn');
    const uploadModal = document.getElementById('uploadModal');
    const uploadNickname = document.getElementById('uploadNickname');
    const comicFilesInput = document.getElementById('comicFilesInput');
    const imagePreviewArea = document.getElementById('imagePreviewArea');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const submitComicBtn = document.getElementById('submitComicBtn');

    // 알림/확인 모달 버튼
    const alertModal = document.getElementById('alert-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // 14. 대전 시작 DOM 요소
    const startContestBtn = document.getElementById('startContestBtn');
    const contestTopicDisplay = document.getElementById('contestTopicDisplay');
    const contestTopicText = document.getElementById('contestTopicText');
    const contestPasswordModal = document.getElementById('contestPasswordModal');
    const contestPasswordInput = document.getElementById('contestPasswordInput');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const submitPasswordBtn = document.getElementById('submitPasswordBtn');
    const contestTopicModal = document.getElementById('contestTopicModal');
    const contestTopicInput = document.getElementById('contestTopicInput');
    const cancelTopicBtn = document.getElementById('cancelTopicBtn');
    const submitTopicBtn = document.getElementById('submitTopicBtn');


    // 유틸리티 함수
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
    };
    
    const showAlert = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.add('hidden');
      modalConfirmBtn.textContent = '확인';
      alertModal.classList.remove('hidden');
      
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
      });
    };

    const showConfirm = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.remove('hidden');
      modalConfirmBtn.textContent = '삭제';
      alertModal.classList.remove('hidden');
      
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
        modalCancelBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(false);
        };
      });
    };
    
    const openComicViewerModal = (comic) => {
      if (!comic || !comic.images) return;
      
      modalComicNickname.textContent = comic.uploaderName || '익명 작가';
      
      // 15. 모달에 제시어 표시
      if (comic.contestTopic) {
        modalComicTopic.textContent = `제시어: ${comic.contestTopic}`;
        modalComicTopic.classList.remove('hidden');
      } else {
        modalComicTopic.classList.add('hidden');
      }
      
      modalImageContainer.innerHTML = '';
      
      comic.images.forEach(imgData => {
        const img = document.createElement('img');
        img.src = imgData.imageUrl;
        img.alt = "네컷만화 이미지";
        img.loading = "lazy";
        modalImageContainer.appendChild(img);
      });
      
      imageModal.style.display='flex';
    };
    const closeImageModal = () => { imageModal.style.display = 'none'; };

    const openUploadModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      uploadNickname.value = window.auth?.currentUser?.displayName || '';
      comicFilesInput.value = '';
      imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">이미지 미리보기</span>';
      uploadModal.style.display = 'flex';
    };
    const closeUploadModal = () => {
      uploadModal.style.display = 'none';
    };

    const handleFilePreview = () => {
      imagePreviewArea.innerHTML = '';
      const files = comicFilesInput.files;
      
      if (files.length === 0) {
        imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">이미지 미리보기</span>';
        return;
      }
      
      const filesToShow = Array.from(files).slice(0, 4);
      
      filesToShow.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          imagePreviewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    };

    // 16. 대전 시작 모달 함수
    const showPasswordModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      contestPasswordInput.value = '';
      contestPasswordModal.classList.remove('hidden');
      contestPasswordInput.focus();
    };
    
    const checkContestPassword = () => {
      const pass = contestPasswordInput.value;
      if (pass === '1234') {
        contestPasswordModal.classList.add('hidden');
        contestTopicInput.value = '';
        contestTopicModal.classList.remove('hidden');
        contestTopicInput.focus();
      } else {
        showAlert('비밀번호가 틀렸습니다.');
      }
    };
    
    const setContestTopic = () => {
      const topic = contestTopicInput.value.trim();
      if (!topic) {
        showAlert('제시어를 입력하세요.');
        return;
      }
      
      // DB에 제시어 저장 (Firestore 스크립트에서 정의)
      if (window.saveContestTopicToDb) {
        window.saveContestTopicToDb(topic);
      }
      
      contestTopicModal.classList.add('hidden');
      // (표시 로직은 onSnapshot이 처리)
    };
    
    // 17. 제시어 UI 업데이트 함수
    const handleTopicSet = (topic) => {
      if (topic) {
        window.currentContestTopic = topic;
        contestTopicText.textContent = topic;
        contestTopicDisplay.classList.remove('hidden');
        showUploadModalBtn.classList.remove('hidden'); // 업로드 버튼 보이기
        startContestBtn.classList.add('hidden'); // 시작 버튼 숨기기
      } else {
        // 제시어가 없는 상태
        window.currentContestTopic = null;
        contestTopicDisplay.classList.add('hidden');
        showUploadModalBtn.classList.add('hidden');
        startContestBtn.classList.remove('hidden');
      }
    };


    // 이벤트 리스너 부착
    const attachEventListeners=()=>{
      closeImageModalBtn.addEventListener('click', closeImageModal);
      imageModal.addEventListener('click',(e)=>{ 
        if(e.target === imageModal) closeImageModal(); 
      }); 
      
      showUploadModalBtn.addEventListener('click', openUploadModal);
      cancelUploadBtn.addEventListener('click', closeUploadModal);
      submitComicBtn.addEventListener('click', () => {
        if (window.handleSubmitComic) window.handleSubmitComic();
      });
      comicFilesInput.addEventListener('change', handleFilePreview);
      
      // 18. 대전 시작 이벤트 리스너
      startContestBtn.addEventListener('click', showPasswordModal);
      cancelPasswordBtn.addEventListener('click', () => contestPasswordModal.classList.add('hidden'));
      submitPasswordBtn.addEventListener('click', checkContestPassword);
      
      cancelTopicBtn.addEventListener('click', () => contestTopicModal.classList.add('hidden'));
      submitTopicBtn.addEventListener('click', setContestTopic);
      
      // Enter 키로 제출
      contestPasswordInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') submitPasswordBtn.click();
      });
      contestTopicInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') submitTopicBtn.click();
      });
    };

    // 네컷만화 갤러리 렌더링
    const renderComics = () => {
      if (!comicGrid) return;
      comicGrid.innerHTML = '';
      
      const sortedComics = [...(window.comics || [])];

      sortedComics.forEach(d => {
        const uploaderName = d.uploaderName || '익명';
        const likeMap = d.likes || {};
        const likeCount = Object.keys(likeMap).length;
        const imageCount = d.images?.length || 0;
        const contestTopic = d.contestTopic || null; // 19. 제시어 데이터
        
        const currentUserId = window.auth?.currentUser?.uid;
        const userHasLiked = currentUserId && likeMap[currentUserId] === true;

        const card = document.createElement('div');
        card.className = 'comic-card relative group';
        card.dataset.id = d.id;
        
        card.innerHTML = `
          <div class="content" data-action="view">
            <span class="nickname-display">${uploaderName}</span>
            <span class="sub-text">${imageCount}컷 만화</span>
            
            <!-- 20. 갤러리 카드에 제시어 표시 -->
            ${contestTopic ? `<span class="topic-display">제시어: ${contestTopic}</span>` : ''}
          </div>
          <div class="info-footer">
            <div class="like-section">
              <button class="like-btn ${userHasLiked ? 'liked' : ''}" data-id="${d.id}" data-action="like">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 11-3 0v-6zM6 10.333v5.167c0 .83.682 1.5 1.502 1.5h6.666A1.5 1.5 0 0015.5 15.5V8.167A1.5 1.5 0 0014 6.667h-2.167A2.5 2.5 0 009.5 4.5V3.083A1.5 1.5 0 008 1.583 1.5 1.5 0 006.5 3v7.333z" />
                </svg>
                <span>따봉!</span>
              </button>
              <span class="like-count">${likeCount} 명이 좋아합니다</span>
            </div>
          </div>
          
          ${currentUserId === d.uploaderId ? `
          <button class="absolute top-2 right-2 bg-[#424242] text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          ` : ''}
        `;
        comicGrid.appendChild(card);
      });
      
      comicGrid.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = async (e) => { 
          e.stopPropagation(); 
          const id = e.currentTarget.dataset.id;
          const action = e.currentTarget.dataset.action;

          if (action === 'delete') {
            if (window.deleteComic) await window.deleteComic(id);
          } else if (action === 'like') {
            if (window.toggleLike) await window.toggleLike(id);
          }
        };
      });

      comicGrid.querySelectorAll('.comic-card').forEach(card => {
        card.onclick = (e) => {
          if (e.target.closest('button[data-action]')) return;
          const id = card.dataset.id;
          const comic = window.comics.find(c => c.id === id);
          if (comic) {
            openComicViewerModal(comic);
          }
        };
      });
    };

    (function init(){ 
      attachEventListeners(); 
    })();
    
  </script>

  <!-- ===== Firebase & 동기화 ===== -->
  <script type="module">
    // 환경 변수에서 Firebase 설정 읽기
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase 앱 초기화
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signInAnonymously, 
      signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, deleteDoc, collection, onSnapshot, 
      addDoc, updateDoc, serverTimestamp, query, orderBy, 
      limit, deleteField, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // 디버그 로그 활성화
    setLogLevel('Debug');
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    window.auth = auth;

    // (기존 로그인 버튼 DOM 제거)
    const loadingOverlay=document.getElementById('loading-overlay');

    // 공용 'comics' 컬렉션 참조 (수정됨)
    const comicsCollectionPath = `artifacts/${appId}/public/data/comics`;
    // 21. 공용 'config' 컬렉션 참조
    const configCollectionPath = `artifacts/${appId}/public/data/config`;
    
    window.cloudRefs = () => {
      return {
        comicsCol: collection(db, comicsCollectionPath),
        configDoc: doc(db, configCollectionPath, "currentTopic") // 'currentTopic' 문서 사용
      };
    };

    window.ensureLogin=()=>{
      if(!window.isAuthReady){ showAlert('데이터 로딩 중입니다.'); return false; }
      if(!auth.currentUser){ showAlert('로그인 후 이용해 주세요.'); return false; }
      // 22. 익명 사용자는 업로드 못하게 막기
      if(auth.currentUser.isAnonymous) {
        showAlert('콘텐츠를 업로드하려면 Google 계정으로 로그인해야 합니다.\n(현재 익명으로 로그인됨)');
        return false;
      }
      return true;
    };

    /**
     * ImgBB에 이미지 하나를 업로드하고 결과 URL (이미지/삭제)을 반환합니다.
     */
    const uploadToImgBB = async (fileOrUrl) => {
      const form = new FormData();
      form.append('image', fileOrUrl);
      
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: form });
      const json = await res.json();
      
      if (!json.success) {
        throw new Error(json?.error?.message || 'ImgBB 업로드 실패');
      }
      
      return {
        imageUrl: json.data?.url || json.data?.display_url,
        deleteUrl: json.data?.delete_url || null
      };
    };

    // 새 업로드 핸들러
    window.handleSubmitComic = async () => {
      if (!ensureLogin()) return;
      
      // 23. 현재 설정된 제시어가 있는지 확인
      if (!window.currentContestTopic) {
        showAlert('현재 설정된 제시어가 없습니다. 대전을 먼저 시작해주세요.');
        return;
      }

      const nickname = document.getElementById('uploadNickname').value.trim();
      const files = document.getElementById('comicFilesInput').files;
      
      if (!nickname) {
        showAlert('닉네임을 입력해주세요.');
        return;
      }
      
      if (files.length === 0) {
        showAlert('하나 이상의 이미지를 선택해주세요.');
        return;
      }

      const filesToUpload = Array.from(files).slice(0, 4);

      loadingOverlay.classList.remove('hidden');
      showFeedbackMessage(`만화 ${filesToUpload.length}장 업로드 중...`);

      try {
        const { comicsCol } = cloudRefs();
        
        const uploadPromises = filesToUpload.map(file => uploadToImgBB(file));
        const uploadedImagesData = await Promise.all(uploadPromises);
        
        await addDoc(comicsCol, {
          images: uploadedImagesData,
          uploaderId: auth.currentUser.uid,
          uploaderName: nickname,
          uploaderDisplayName: auth.currentUser.displayName || '익명',
          timestamp: serverTimestamp(),
          likes: {},
          contestTopic: window.currentContestTopic // 24. 제시어 저장
        });

        loadingOverlay.classList.add('hidden');
        showFeedbackMessage('만화가 성공적으로 등록되었습니다!');
        if(typeof closeUploadModal === 'function') closeUploadModal();

      } catch (err) {
        loadingOverlay.classList.add('hidden');
        showAlert('만화 업로드 실패: ' + (err.message || '오류'));
      }
    };
    
    // 네컷만화 삭제
    window.deleteComic = async (id)=>{
      if(!ensureLogin()) return; // 익명 사용자는 삭제 불가
      try{
        const comic = (window.comics||[]).find(d=>d.id===id); 
        if(!comic) throw new Error('만화 항목을 찾을 수 없습니다.');
        
        if(comic.uploaderId !== auth.currentUser.uid) {
          showAlert('자신이 올린 만화만 삭제할 수 있습니다.');
          return;
        }

        if (!(await showConfirm('정말로 이 만화를 삭제하시겠습니까?'))) return;

        const { comicsCol } = cloudRefs();
        
        // ImgBB 삭제 (CORS 오류로 인해 주석 처리)
        /*
        if(comic.images && Array.isArray(comic.images)){ 
          const deletePromises = comic.images
            .filter(img => img.deleteUrl)
            .map(img => fetch(img.deleteUrl, { method: 'GET' }).catch(e => console.error("ImgBB 삭제 오류:", e)));
          await Promise.allSettled(deletePromises);
        }
        */
        
        await deleteDoc(doc(comicsCol, id));
        showFeedbackMessage('만화가 삭제되었습니다.');

      }catch(e){
        showAlert('만화 삭제 중 오류: '+(e?.message||'unknown'));
      }
    };

    // '따봉' (좋아요) 토글 기능
    window.toggleLike = async (id) => {
      // 25. 좋아요는 익명 사용자도 가능하도록 수정
      if(!window.isAuthReady){ showAlert('데이터 로딩 중입니다.'); return false; }
      if(!auth.currentUser){ showAlert('로그인 후 이용해 주세요.'); return false; }
      // if (!ensureLogin()) return; // -> 로그인만 하면 누구나 가능하게

      const userId = auth.currentUser.uid;
      const comicRef = doc(db, comicsCollectionPath, id);
      
      const comic = window.comics.find(c => c.id === id);
      if (!comic) return;

      const userHasLiked = (comic.likes || {})[userId] === true;
      
      try {
        if (userHasLiked) {
          await updateDoc(comicRef, { [`likes.${userId}`]: deleteField() });
        } else {
          await updateDoc(comicRef, { [`likes.${userId}`]: true });
        }
      } catch (e) {
        console.error("좋아요 업데이트 오류:", e);
        showAlert("좋아요 상태를 업데이트하는 중 오류가 발생했습니다.");
      }
    };
    
    // 26. 제시어 DB 저장 함수
    window.saveContestTopicToDb = async (topic) => {
      if (!ensureLogin()) return; // 관리자(익명 아닌 유저)만 설정 가능
      
      const { configDoc } = cloudRefs();
      try {
        await setDoc(configDoc, {
          name: topic,
          setBy: auth.currentUser.displayName || auth.currentUser.uid,
          updatedAt: serverTimestamp()
        });
        showFeedbackMessage('새로운 제시어가 설정되었습니다!');
      } catch (e) {
        console.error("제시어 저장 오류:", e);
        showAlert("제시어를 설정하는 중 오류가 발생했습니다.");
      }
    };

    // ===== 실시간 동기화 =====
    window.__unsubs=[];
    async function setupRealtimeSync(userId){
      const { comicsCol, configDoc } = cloudRefs();
      
      window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); 
      window.__unsubs=[];

      // 1. 만화 갤러리 구독
      const q = query(comicsCol, orderBy("timestamp", "desc"), limit(100));
      const unsubComics = onSnapshot(q, (snap) => { 
          window.comics = snap.docs.map(d=>({id:d.id,...d.data()})); 
          if(typeof renderComics === 'function') renderComics(); 
      }, (error) => {
          console.error("Comics snapshot error: ", error);
          if (error.code === 'permission-denied') {
            showAlert("데이터를 읽을 수 없습니다. Firestore 보안 규칙을 확인하세요. ('comics' 컬렉션에 대한 'read: true' 설정 필요)");
          }
      });
      // [오류 수정] 'unComics' (오타) -> 'unsubComics'
      window.__unsubs.push(unsubComics);

      // 2. 27. 현재 제시어 구독
      const unsubConfig = onSnapshot(configDoc, (docSnap) => {
        let currentTopic = null;
        if (docSnap.exists()) {
          currentTopic = docSnap.data().name;
        }
        // UI 업데이트 함수 호출 (UI 스크립트에 정의됨)
        if (typeof handleTopicSet === 'function') {
          handleTopicSet(currentTopic);
        } else {
          console.warn('handleTopicSet 함수를 찾을 수 없습니다.');
        }
      }, (error) => {
          console.error("Config snapshot error: ", error);
          if (error.code === 'permission-denied') {
            showAlert("제시어 정보를 읽을 수 없습니다. Firestore 보안 규칙을 확인하세요. ('config/currentTopic'에 대한 'read: true' 설정 필요)");
          }
      });
      window.__unsubs.push(unsubConfig);
    }

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden'); 
      window.isAuthReady=false;
      const currentUserId = user ? user.uid : null;
      
      if(user){
        // 28. 로그인 상태 (익명/구글)
        // (UI 표시는 숨겨졌으므로 제거)
        await setupRealtimeSync(currentUserId);
      } else {
        // 29. 로그아웃 상태 (최초 진입 등)
        // (UI 표시는 숨겨졌으므로 제거)
        
        // 로그아웃 시에도 갤러리는 계속 볼 수 있도록 익명 로그인을 시도
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
          // (성공하면 onAuthStateChanged가 다시 호출됨)
        } catch (error) {
          console.error("익명 로그인 실패:", error);
          loadingOverlay.classList.add('hidden');
          window.isAuthReady = true;
          showAlert("데이터베이스 연결에 실패했습니다. 페이지를 새로고침해주세요.");
        }
        return; // onAuthStateChanged 재실행을 기다림
      }
      
      loadingOverlay.classList.add('hidden'); 
      window.isAuthReady=true;
      
      // 30. (로그인 상태가 변경될 때마다 렌더링 다시 - 삭제 버튼/좋아요 표시 때문)
      if(typeof renderComics==='function') renderComics();
    });
  </script>
</body>
</html>

