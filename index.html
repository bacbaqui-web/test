<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>사랑방 띵곡 플레이어</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;background:#111;color:#eee;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
  .wrap{max-width:900px;margin:24px auto;padding:0 16px;width:100%}
  .card{border:1px solid #444;border-radius:10px;padding:16px;margin:12px 0;background:#222}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#63b3ed;color:#fff;border:0;border-radius:999px;padding:.6rem 1rem;cursor:pointer}
  .btn:hover{background:#4299e1}
  .btn:disabled{background:#4a5568;cursor:not-allowed}
  .btn-toggle{background:#555}
  .btn-toggle.active{background:#fc8181}
  .btn-sort{background:#555;color:#fff}
  .btn-sort.most-liked{background:#f6ad55} /* 노랑 */
  .btn-sort.user-liked{background:#48bb78} /* 초록 */

  .muted{color:#a0aec0}
  input{background:#1f2937;color:#eee;border:1px solid #374151;border-radius:8px;padding:.55rem .7rem;flex:1;min-width:220px;outline:none}
  input:focus{border-color:#63b3ed}

  .item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border-bottom:1px solid #2f3743;cursor:pointer}
  .item:hover{background:#2a3340}
  .item:last-child{border-bottom:none}
  .item .delete-btn{background:none;border:none;color:#fc8181;cursor:pointer;font-size:1.2em;line-height:1;margin-left:10px;opacity:.7}
  .item .delete-btn:hover{opacity:1}
  .item .info-icon{background:none;border:none;color:#63b3ed;cursor:pointer;font-size:1.2em;margin-right:5px}

  .item .like-btn,.current-like .like-btn{background:none;border:none;cursor:pointer;font-size:1.2em;color:inherit}
  .like-count{font-size:.9em;color:#a0aec0;margin-left:-5px;margin-right:5px}
  .uploader-btn{background:none;border:none;color:#63b3ed;cursor:pointer;font-size:.9em;margin-right:5px;padding:0}

  .video-player{aspect-ratio:16/9;width:100%;max-width:800px;margin:8px auto;border-radius:8px;overflow:hidden;position:relative}
  .message-box{display:none;background:#2d3748;color:#fff;padding:12px;border-radius:8px;text-align:center;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000}
  #player{height:100%;width:100%}

  .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
  .modal-content{background:#222;padding:20px;border:1px solid #444;width:80%;max-width:500px;border-radius:10px}
  .modal-content .modal-section{margin-bottom:15px}
  .modal-content .modal-section label{display:block;margin-bottom:5px;font-weight:bold}
  .modal-content input[type="text"],.modal-content textarea{width:100%;box-sizing:border-box;background:#1f2937;color:#eee;border:1px solid #374151;border-radius:8px;padding:10px;outline:none}
  .modal-content textarea{height:100px;resize:vertical}
  .modal-content .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold}
  .modal-content .close-btn:hover{color:#fff;cursor:pointer}
  .modal-content .save-btn{background:#38b2ac;color:#fff;border:0;border-radius:999px;padding:.6rem 1rem;margin-top:10px;cursor:pointer}

  .song-info-container{display:flex;align-items:center;justify-content:center;margin-top:10px;gap:10px;font-size:1.1em;font-weight:bold;text-align:center}
  .song-info-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 190px);display:flex;align-items:center;justify-content:center}
  .current-like{display:flex;align-items:center;gap:6px}
  .current-info-btn{background:none;border:none;color:#63b3ed;cursor:pointer;font-size:1.2em;margin-right:5px;padding:0;width:40px;height:40px;display:flex;justify-content:center;align-items:center}

  #currentSongNotes{border-top:1px solid #444;margin-top:10px;padding-top:10px}
  #currentSongNotes p{margin:0 0 10px 0;color:#ccc}
  .song-details{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:flex;align-items:center;gap:8px}
  .new-tag{background:#f6ad55;color:#fff;font-size:.7em;font-weight:bold;padding:2px 6px;border-radius:999px;margin-left:8px;text-transform:uppercase}
</style>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div id="message-box" class="message-box"></div>

<div class="wrap">
  <h1 style="text-align:center">사랑방 띵곡 플레이어</h1>
  <div class="card">
    <div id="player" class="video-player"></div>

    <div class="song-info-container">
      <button id="prevBtn" class="btn">&lt;</button>
      <div id="currentSongInfo" class="song-info-text"><span class="muted">현재 재생 없음</span></div>
      <div class="current-like">
        <button id="currentLikeBtn" class="like-btn" disabled>👍🏿</button>
        <span id="currentLikeCount" class="like-count">0</span>
      </div>
      <button id="nextBtn" class="btn">&gt;</button>
    </div>

    <div id="currentSongNotes"><span class="muted"></span></div>

    <div class="row" style="margin-top:10px">
      <input id="url" placeholder="유튜브 링크 또는 제목"/>
      <button id="add" class="btn">추가</button>
      <button id="shuffleBtn" class="btn btn-toggle">셔플</button>
      <button id="likeSortBtn" class="btn btn-sort">따봉 정렬</button>
    </div>

    <div id="playlist" class="card" style="margin-top:10px"><div class="muted">재생목록 없음</div></div>
  </div>
</div>

<!-- Info Modal -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>노래 정보</h3>
    <div class="modal-section">
      <label for="songTitleInput">노래 제목</label>
      <input id="songTitleInput" type="text"/>
    </div>
    <div class="modal-section">
      <label for="artistInput">아티스트</label>
      <input id="artistInput" type="text"/>
    </div>
    <div class="modal-section">
      <label for="uploaderInput">올린 사람</label>
      <input id="uploaderInput" type="text"/>
    </div>
    <div class="modal-section">
      <label for="infoTextarea">노래 정보</label>
      <textarea id="infoTextarea"></textarea>
    </div>
    <div class="modal-section">
      <label for="commentTextarea">댓글</label>
      <textarea id="commentTextarea"></textarea>
    </div>
    <button id="saveInfoBtn" class="save-btn">저장</button>
  </div>
</div>

<script>
/* ===== Firebase ===== */
const __firebase_config='{"apiKey":"AIzaSyDz6xGJNKXinG5rREjdrPz7toIYGZXzilU","authDomain":"sarangbangmusicplaylist.firebaseapp.com","projectId":"sarangbangmusicplaylist","storageBucket":"sarangbangmusicplaylist.appspot.com","messagingSenderId":"193412502606","appId":"1:193412502606:web:0f7f9ddbef1ee6711d1ff"}';
const firebaseConfig=JSON.parse(__firebase_config);
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* ===== App State ===== */
const appId="default-app-id";
let userId=null, player=null, isYoutubeApiReady=false;

const state={
  playlist:[],
  notes:{},
  likeAgg:{},        // {videoId:{likeCount}}
  myLikedSet:new Set(), // Set<videoId>
  likeSnapReady:false,
  myLikeSnapReady:false,
  likeSortMode:0,    // 0 최신, 1 따봉많은순, 2 내따봉우선
  isShuffle:false,
  deck:[],
  currentVid:null,
  currentIdx:-1
};

/* ===== UI refs ===== */
const listEl=document.getElementById('playlist');
const likeSortBtn=document.getElementById('likeSortBtn');
const shuffleBtn=document.getElementById('shuffleBtn');
const currentLikeBtn=document.getElementById('currentLikeBtn');
const currentLikeCount=document.getElementById('currentLikeCount');
const currentSongInfo=document.getElementById('currentSongInfo');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const msg=document.getElementById('message-box');

/* ===== YouTube ===== */
window.onYouTubeIframeAPIReady=function(){
  isYoutubeApiReady=true;
  player=new YT.Player('player',{height:'100%',width:'100%',videoId:'',playerVars:{autoplay:1,controls:1},events:{onStateChange:e=>{if(e.data===YT.PlayerState.ENDED) playNext();}}});
};

/* ===== Helpers ===== */
function showMessage(t,kind='info'){ msg.textContent=t; msg.style.background=(kind==='error')?'#fc8181':'#2d3748'; msg.style.display='block'; setTimeout(()=>msg.style.display='none',1200); }
function isLiked(videoId){ return state.myLikedSet.has(videoId); }
function likeCount(videoId){ return state.likeAgg[videoId]?.likeCount||0; }
function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function readyLikes(){ return state.likeSnapReady && state.myLikeSnapReady; }

/* ===== Auth then realtime ===== */
firebase.auth().signInAnonymously().then(cred=>{
  userId=cred.user.uid;
  wireRealtime();
  wireUI();
});

/* ===== Realtime ===== */
function wireRealtime(){
  // playlist
  db.collection('artifacts').doc(appId).collection('public').doc('data')
    .collection('playlist_state').doc('main_playlist')
    .onSnapshot(s=>{
      const d=s.data()||{};
      state.playlist=Array.isArray(d.playlist)?d.playlist:[];
      renderList();
    });

  // notes
  db.collection('artifacts').doc(appId).collection('public').doc('data')
    .collection('notes').onSnapshot(ss=>{
      const m={}; ss.forEach(doc=>m[doc.id]=doc.data());
      state.notes=m; renderList();
    });

  // like aggregate per song
  db.collection('artifacts').doc(appId).collection('public').doc('data')
    .collection('song_likes').onSnapshot(ss=>{
      const m={}; ss.forEach(doc=>m[doc.id]=doc.data());
      state.likeAgg=m; state.likeSnapReady=true;
      renderList(); renderCurrentLikeUI();
      if(state.isShuffle) rebuildDeck();
    });

  // my likes set: users/{uid}/my_likes/*
  db.collection('users').doc(userId).collection('my_likes')
    .onSnapshot(ss=>{
      const set=new Set();
      ss.forEach(doc=>set.add(doc.id));
      state.myLikedSet=set; state.myLikeSnapReady=true;
      renderList(); renderCurrentLikeUI();
      if(state.isShuffle) rebuildDeck();
    });
}

/* ===== Visible list with sorting ===== */
function getVisibleList(){
  const list=[...state.playlist];
  // 최신순 기본
  list.sort((a,b)=>{
    const ta=a.createdAt?.toDate?a.createdAt.toDate().getTime():a.createdAt?.getTime?.()||0;
    const tb=b.createdAt?.toDate?b.createdAt.toDate().getTime():b.createdAt?.getTime?.()||0;
    return tb-ta;
  });
  if(state.likeSortMode===1){
    list.sort((a,b)=> likeCount(b.videoId)-likeCount(a.videoId));
  }else if(state.likeSortMode===2){
    const liked=[], others=[];
    list.forEach(it=> (isLiked(it.videoId)?liked:others).push(it));
    list.splice(0,list.length,...liked,...others);
  }
  return list;
}

/* ===== Deck ===== */
function rebuildDeck(){
  const ids=getVisibleList().map(s=>s.videoId).filter(id=>id!==state.currentVid);
  if(state.likeSortMode===2){
    const a=ids.filter(isLiked);
    const b=ids.filter(id=>!isLiked(id));
    state.deck=[...shuffle(a),...shuffle(b)];
  }else{
    state.deck=shuffle(ids);
  }
}

/* ===== Render ===== */
function renderList(){
  listEl.innerHTML='';
  const list=getVisibleList();
  if(!list.length){ listEl.innerHTML='<div class="muted">재생목록 없음</div>'; renderCurrent(); return; }

  list.forEach((item)=>{
    const row=document.createElement('div'); row.className='item';
    row.onclick=()=> play(item.videoId);

    const left=document.createElement('div'); left.className='song-details';
    const info=document.createElement('button'); info.className='info-icon'; info.innerHTML='&#x24D8;';
    info.onclick=(e)=>{e.stopPropagation(); openInfo(item.videoId);};
    const title=document.createElement('span'); title.textContent=`${item.artist} - ${item.title}`;
    const uploaderBtn=document.createElement('button'); uploaderBtn.className='uploader-btn';
    uploaderBtn.textContent=state.notes[item.videoId]?.uploader || '익명';
    uploaderBtn.onclick=(e)=>{ e.stopPropagation(); sortByUploader(uploaderBtn.textContent); };
    left.appendChild(info); left.appendChild(title); left.appendChild(uploaderBtn);

    const right=document.createElement('div');
    const likeBtn=document.createElement('button'); likeBtn.className='like-btn';
    likeBtn.disabled=!readyLikes();
    likeBtn.textContent = isLiked(item.videoId) ? '👍' : '👍🏿';
    likeBtn.onclick=async (e)=>{ e.stopPropagation(); await toggleLike(item.videoId, likeBtn); };
    const cnt=document.createElement('span'); cnt.className='like-count'; cnt.textContent=likeCount(item.videoId);

    right.appendChild(likeBtn); right.appendChild(cnt);

    const del=document.createElement('button'); del.className='delete-btn'; del.innerHTML='&#x2715;';
    del.onclick=async (e)=>{ e.stopPropagation(); if(await confirmDel()) removeFromPlaylist(item.videoId); };

    row.appendChild(left); row.appendChild(right); row.appendChild(del);
    listEl.appendChild(row);
  });

  renderCurrent();
}

function renderCurrent(){
  const v=state.currentVid;
  if(!v){ currentSongInfo.innerHTML='<span class="muted">현재 재생 없음</span>'; renderCurrentLikeUI(); return; }
  const meta=state.playlist.find(s=>s.videoId===v);
  if(meta){
    const btn=`<button class="current-info-btn" onclick="openInfo('${v}')">&#x24D8;</button>`;
    currentSongInfo.innerHTML=btn+`<span style="font-weight:bold">${meta.title}</span><span class="muted" style="margin-left:6px"> - ${meta.artist}</span>`;
  }else{
    currentSongInfo.innerHTML='<span class="muted">현재 재생 없음</span>';
  }
  renderCurrentLikeUI();
}

function renderCurrentLikeUI(){
  const v=state.currentVid;
  const mine = v ? isLiked(v) : false;
  currentLikeBtn.disabled = !readyLikes() || !v;
  currentLikeBtn.textContent = mine ? '👍' : '👍🏿';
  currentLikeBtn.onclick = async ()=>{ if(!readyLikes()||!v) return; await toggleLike(v, currentLikeBtn); };
  currentLikeCount.textContent = v ? likeCount(v) : 0;
}

/* ===== Like toggle: users/{uid}/my_likes/{vid} ↔ song_likes/{vid}.likeCount ===== */
async function toggleLike(videoId, btnEl){
  if(!userId) return;
  btnEl.disabled=true; // 연타 방지

  const aggRef = db.collection('artifacts').doc(appId).collection('public').doc('data')
                   .collection('song_likes').doc(videoId);
  const myRef  = db.collection('users').doc(userId).collection('my_likes').doc(videoId);

  try{
    await db.runTransaction(async tr=>{
      const [aggSnap,mySnap]=await Promise.all([tr.get(aggRef), tr.get(myRef)]);
      let count = aggSnap.exists ? (aggSnap.data().likeCount||0) : 0;

      if(mySnap.exists){
        // 취소
        count = Math.max(0, count-1);
        tr.delete(myRef);
        tr.set(aggRef,{ likeCount:count, updatedAt:firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
      }else{
        // 신규 좋아요
        count = count+1;
        tr.set(myRef,{ likedAt: firebase.firestore.FieldValue.serverTimestamp() });
        tr.set(aggRef,{ likeCount:count, updatedAt:firebase.firestore.FieldValue.serverTimestamp() },{merge:true});
      }
    });
    // UI는 스냅샷으로만 갱신. 여기서 직접 증감하지 않음.
  }catch(e){
    console.error(e);
    showMessage('좋아요 처리 실패','error');
  }finally{
    btnEl.disabled=false;
  }
}

/* ===== Player ===== */
function play(videoId){
  if(!isYoutubeApiReady) return;
  player.loadVideoById(videoId);
  state.currentVid=videoId;
  state.currentIdx = getVisibleList().findIndex(s=>s.videoId===videoId);
  // 셔플 중이면 현재 곡 제거
  state.deck = state.deck.filter(id=>id!==videoId);
  renderCurrent();
}
function playNext(){
  if(state.isShuffle){
    if(state.deck.length===0) rebuildDeck();
    const next=state.deck.shift();
    if(next){ play(next); }
    return;
  }
  const list=getVisibleList(); if(!list.length) return;
  const idx=(state.currentIdx+1)%list.length;
  play(list[idx].videoId);
}

/* ===== UI wiring ===== */
function wireUI(){
  likeSortBtn.onclick=()=>{
    state.likeSortMode=(state.likeSortMode+1)%3;
    likeSortBtn.classList.remove('most-liked','user-liked');
    if(state.likeSortMode===1) likeSortBtn.classList.add('most-liked');
    if(state.likeSortMode===2) likeSortBtn.classList.add('user-liked');
    renderList(); if(state.isShuffle) rebuildDeck();
  };
  shuffleBtn.onclick=()=>{
    state.isShuffle=!state.isShuffle;
    shuffleBtn.classList.toggle('active',state.isShuffle);
    if(state.isShuffle){ rebuildDeck(); showMessage(state.likeSortMode===2?'내 좋아요 먼저 셔플':'전체 셔플'); }
    else showMessage('셔플 해제');
  };
  prevBtn.onclick=()=>showMessage('이전 곡 미지원(일반 재생만 사용)');
  nextBtn.onclick=()=>playNext();
}

/* ===== Misc ===== */
function sortByUploader(name){
  const list=[...state.playlist];
  list.sort((a,b)=>{
    const ua=(state.notes[a.videoId]?.uploader||'익명')===name?0:1;
    const ub=(state.notes[b.videoId]?.uploader||'익명')===name?0:1;
    return ua-ub;
  });
  state.playlist=list; renderList();
}
async function confirmDel(){
  return window.confirm('정말로 삭제하시겠습니까?');
}
function removeFromPlaylist(videoId){
  const list=state.playlist.filter(s=>s.videoId!==videoId);
  db.collection('artifacts').doc(appId).collection('public').doc('data')
    .collection('playlist_state').doc('main_playlist')
    .set({playlist:list,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
}

/* ===== Info modal stubs ===== */
function openInfo(videoId){ /* 필요 시 기존 모달 로직 재결합 */ }

/* start */
</script>
</body>
</html>
