<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì œ2íšŒ ë„¤ì»·ë§Œí™”ëŒ€ì „</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem;
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    #comic-grid { column-count: 2; column-gap: 1rem; margin-top: 1.5rem; display: block; }
    @media (min-width: 640px) { #comic-grid { column-count: 3; } }
    @media (min-width: 1024px) { #comic-grid { column-count: 4; } }
    @media (min-width: 1280px) { #comic-grid { column-count: 5; } }
    .comic-card { position: relative; transition: all .2s ease-in-out; background: #333; border-radius: 12px; overflow: hidden; margin-bottom: 1rem; break-inside: avoid; width: 100%; display: block; cursor: pointer; border: 3px solid transparent; }
    .comic-card.disabled { cursor: not-allowed; opacity: 0.7; }
    .comic-card.rank-1 { border-color: #FFD700; }
    .comic-card.rank-2 { border-color: #C0C0C0; }
    .comic-card.rank-3 { border-color: #CD7F32; }
    .rank-medal { position: absolute; top: 8px; left: 8px; font-size: 1.8rem; line-height: 1; text-shadow: 0 1px 3px rgba(0,0,0,0.5); z-index: 10; }
    .comic-card:not(.disabled):hover { transform: translateY(-5px); background: #444; }
    .comic-card .content { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; min-height: 120px; padding: 16px; text-align: center; background-color: #1a1a1a; position: relative; }
    .comic-card .nickname-display { font-size: 1.25rem; font-weight: 700; color: #fff; word-break: break-all; }
    .comic-card .sub-text { font-size: 0.8rem; color: #aaa; margin-top: 4px; }
    .comic-card .info-footer { padding: 12px; background: #333; text-align: left; }
    .comic-card .like-section { display: flex; justify-content: space-between; align-items: center; }
    .like-btn { display: flex; align-items: center; gap: 6px; background: #555; color: white; padding: 6px 10px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; transition: all 0.2s ease; cursor: pointer; border: none; }
    .like-btn.liked { background: #2563eb; color: white; }
    .like-btn:not(.disabled):hover:not(.liked) { background: #666; }
    .like-btn.disabled { background: #444; color: #777; cursor: not-allowed; }
    .like-count { font-size: 0.9rem; font-weight: 700; color: #ddd; }
    #imageModal.modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    #imageModal .modal-content { background-color: #1a1a1a; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,.5); border-radius: 12px; max-width: 90vw; max-height: 90vh; width: auto; height: auto; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; cursor: default; overflow-y: auto; }
    #modalComicNickname { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #444; width: 100%; text-align: center; }
    #modalComicTopic { font-size: 1rem; font-weight: 400; color: #bbb; margin-bottom: 1rem; text-align: center; }
    #modalImageContainer { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 500px; }
    #modalImageContainer img { width: 100%; height: auto; display: block; border-radius: 8px; }
    #modalImage { display: none; }
    #uploadModal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    #uploadModal .modal-content { background: #2a2a2a; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.5); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    #imagePreviewArea { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 1rem; padding: 10px; background: #1a1a1a; border-radius: 8px; min-height: 100px; }
    .preview-image { width: 100%; height: auto; object-fit: cover; border-radius: 4px; aspect-ratio: 1 / 1; }
    .file-input-label { background: #444; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 700; transition: background .2s; }
    .file-input-label:hover { background: #555; }
    #comicFilesInput { display: none; }
    .admin-button { background: #8B5CF6; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 700; transition: background .2s; }
    .admin-button:hover { background: #7C3AED; }
    #endContestBtn { background: #EC4899; }
    #endContestBtn:hover { background: #DB2777; }
    #startVotingBtn { background: #10B981; }
    #startVotingBtn:hover { background: #059669; }
    #endVotingBtn { background: #EF4444; }
    #endVotingBtn:hover { background: #DC2626; }
    .password-modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; justify-content: center; align-items: center; z-index: 1001; }
    .password-modal .modal-content { background: #2a2a2a; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.5); width: 90%; max-width: 400px; }
    .password-modal h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
    .password-modal input[type="text"], .password-modal input[type="password"] { width: 100%; padding: 10px; border-radius: 8px; background: #1a1a1a; border: 1px solid #444; color: white; font-size: 1rem; }
    .password-modal p { color: #F87171; font-size: 0.8rem; height: 1.2rem; margin-top: 0.25rem; }
    @media (max-width:768px){
      body{padding:12px;gap:0.5rem}.section-card{padding:12px;border-radius:0}
      #uploadModal .modal-content { width: 95%; padding: 16px; }
      #imagePreviewArea { grid-template-columns: repeat(2, 1fr); }
      #modalImageContainer { max-width: 100%; }
    }
  </style>
</head>
<body class="text-white">

  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2 mb-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <h1 class="text-3xl font-bold text-center text-white">
    <span class="text-blue-400">ì œ2íšŒ ë„¤ì»·ë§Œí™”</span>
    <span class="text-white">ëŒ€ì „</span>
    <span class="text-red-400">!</span>
  </h1>
  
  <h2 id="currentTopicDisplay" class="text-xl font-bold text-yellow-300 text-center mb-4 hidden">
    ì£¼ì œ: <span id="currentTopicText"></span>
  </h2>

  <div id="comics-section" class="section-card text-left">
    <section class="text-center mb-6 flex flex-wrap justify-center gap-4">
      <button id="startContestBtn" class="admin-button">ëŒ€ì „ ì‹œì‘í•˜ê¸°</button>
      <button id="showUploadModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105 hidden">+ ë„¤ì»·ë§Œí™” ì˜¬ë¦¬ê¸°</button>
      <button id="endContestBtn" class="admin-button hidden">ì˜¬ë¦¬ê¸° ì¢…ë£Œ</button>
      <button id="startVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì‹œì‘í•˜ê¸°</button>
      <button id="endVotingBtn" class="admin-button hidden">íˆ¬í‘œ ì¢…ë£Œ (ê²°ê³¼ ë°œí‘œ)</button>
    </section>
    <section id="comic-grid"></section>
  </div>

  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h3 id="modalComicNickname" class="text-xl font-bold mb-2 text-white text-center"></h3>
      <h4 id="modalComicTopic" class="text-lg text-yellow-300 mb-4 text-center"></h4>
      <div id="modalImageContainer"></div>
      <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="hidden" />
    </div>
  </div>

  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4">ë„¤ì»·ë§Œí™” ì˜¬ë¦¬ê¸°</h2>
      <div class="mb-4">
        <label for="uploadNickname" class="block text-sm font-medium text-gray-300 mb-1">ë‹‰ë„¤ì„</label>
        <input type="text" id="uploadNickname" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="ì‘ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="mb-4">
        <label for="comicFilesInput" class="file-input-label">ë§Œí™” ì´ë¯¸ì§€ ì„ íƒ (ìµœëŒ€ 4ì¥)</label>
        <input type="file" id="comicFilesInput" multiple accept="image/*">
        <p class="text-xs text-gray-400 mt-2">íŒ: 1~4ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”. 4ì¥ì´ ë„˜ìœ¼ë©´ 4ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œë©ë‹ˆë‹¤.</p>
      </div>
      <div id="imagePreviewArea">
        <span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancelUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitComicBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ì œì¶œ</button>
      </div>
    </div>
  </div>

  <div id="contestPasswordModal" class="password-modal">
    <div class="modal-content">
      <h2>ëŒ€ì „ ì‹œì‘í•˜ê¸°</h2>
      <label for="contestPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="contestPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 1234">
      <p id="contestPasswordError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelContestPassword" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitContestPassword" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg">ë‹¤ìŒ</button>
      </div>
    </div>
  </div>

  <div id="topicModal" class="password-modal">
    <div class="modal-content">
      <h2>ì œì‹œì–´ ì…ë ¥</h2>
      <label for="topicInput" class="block text-sm font-medium text-gray-300 mb-1">ì´ë²ˆ ëŒ€ì „ì˜ ì œì‹œì–´</label>
      <input type="text" id="topicInput" placeholder="ì˜ˆ: ìš°ì£¼, ë¼ë©´, ...">
      <p id="topicError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelTopic" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitTopic" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg">ëŒ€ì „ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="contestEndPasswordModal" class="password-modal">
    <div class="modal-content">
      <h2>ì—…ë¡œë“œ ì¢…ë£Œ</h2>
      <label for="contestEndPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="contestEndPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 1234">
      <p id="contestEndPasswordError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelContestEndPassword" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitContestEndPassword" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg">ì¢…ë£Œ</button>
      </div>
    </div>
  </div>

  <div id="contestStartVotingPasswordModal" class="password-modal">
    <div class="modal-content">
      <h2>íˆ¬í‘œ ì‹œì‘</h2>
      <label for="contestStartVotingPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="contestStartVotingPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 1234">
      <p id="contestStartVotingPasswordError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelContestStartVotingPassword" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitContestStartVotingPassword" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">íˆ¬í‘œ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="contestEndVotingPasswordModal" class="password-modal">
    <div class="modal-content">
      <h2>íˆ¬í‘œ ì¢…ë£Œ (ê²°ê³¼ ë°œí‘œ)</h2>
      <label for="contestEndVotingPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="contestEndVotingPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 1234">
      <p id="contestEndVotingPasswordError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelContestEndVotingPassword" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitContestEndVotingPassword" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ê²°ê³¼ ë°œí‘œ</button>
      </div>
    </div>
  </div>

  <div id="adminPreviewPasswordModal" class="password-modal">
    <div class="modal-content">
      <h2>ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°</h2>
      <label for="adminPreviewPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="adminPreviewPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 1234">
      <p id="adminPreviewPasswordError"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelAdminPreviewPassword" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitAdminPreviewPassword" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1002]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-lg text-center font-medium"></p>
      <div class="mt-4 flex justify-center gap-4">
        <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 hidden">ì·¨ì†Œ</button>
        <button id="modal-confirm-btn" class="px-4 py-2 bg-[#424242] text-white rounded-md hover:bg-[#525252]">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-4 text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInAnonymously, 
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, deleteDoc, collection, onSnapshot, 
      addDoc, updateDoc, serverTimestamp, query, orderBy, 
      limit, deleteField, setDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1) Firebase ì„¤ì • (ê·€í•˜ê°€ ì œê³µí•œ ê°’, storageBucket ìˆ˜ì • í¬í•¨)
    const YOUR_FIREBASE_CONFIG = {
      apiKey: "AIzaSyBqtqjmEIPydo7ibbGePf_oEb0GXVcZI6E",
      authDomain: "ne-cut-battle.firebaseapp.com",
      projectId: "ne-cut-battle",
      storageBucket: "ne-cut-battle.appspot.com",
      messagingSenderId: "565872837701",
      appId: "1:565872837701:web:3c57c4bab8d37644018f2c",
      measurementId: "G-EDHCL46T9M"
    };

    // 2) Canvas App ID: Geminiì—ì„œ ìë™ ì œê³µë˜ëŠ” ê°’ì´ ì•„ë‹Œ ê²½ìš° ì§ì ‘ ì´ë¦„ ì§€ì •
    //    Firestore ë°ì´í„° ê²½ë¡œëŠ” artifacts/{CANVAS_APP_ID_FOR_FIRESTORE}/public/data/...
    const CANVAS_APP_ID_FOR_FIRESTORE = "necut_battle_2025";

    // 3) ImgBB API í‚¤: ì‹¤ì œ í‚¤ë¡œ êµì²´í•˜ì„¸ìš”. (í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë˜ë¯€ë¡œ í…ŒìŠ¤íŠ¸ìš© ê¶Œì¥)
    const IMGBB_API_KEY = "REPLACE_WITH_IMGBB_API_KEY";

    // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ë°°í¬ ì‹œ ë³€ê²½ ê¶Œì¥)
    const ADMIN_PASSWORD = "1234";

    // ì „ì—­ ìƒíƒœ
    window.comics = [];
    window.isAuthReady = false;
    window.currentTopic = "";
    window.currentContestStatus = "";
    window.comicToPreview = null;

    // DOM
    const comicGrid = document.getElementById('comic-grid');
    const imageModal = document.getElementById('imageModal');
    const modalImageContainer = document.getElementById('modalImageContainer'); 
    const modalComicNickname = document.getElementById('modalComicNickname');
    const modalComicTopic = document.getElementById('modalComicTopic');
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');

    const startContestBtn = document.getElementById('startContestBtn');
    const showUploadModalBtn = document.getElementById('showUploadModalBtn');
    const endContestBtn = document.getElementById('endContestBtn');
    const startVotingBtn = document.getElementById('startVotingBtn');
    const endVotingBtn = document.getElementById('endVotingBtn');

    const currentTopicDisplay = document.getElementById('currentTopicDisplay');
    const currentTopicText = document.getElementById('currentTopicText');

    const uploadModal = document.getElementById('uploadModal');
    const uploadNickname = document.getElementById('uploadNickname');
    const comicFilesInput = document.getElementById('comicFilesInput');
    const imagePreviewArea = document.getElementById('imagePreviewArea');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const submitComicBtn = document.getElementById('submitComicBtn');

    const alertModal = document.getElementById('alert-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    const contestPasswordModal = document.getElementById('contestPasswordModal');
    const contestPasswordInput = document.getElementById('contestPasswordInput');
    const contestPasswordError = document.getElementById('contestPasswordError');
    const cancelContestPassword = document.getElementById('cancelContestPassword');
    const submitContestPassword = document.getElementById('submitContestPassword');

    const topicModal = document.getElementById('topicModal');
    const topicInput = document.getElementById('topicInput');
    const topicError = document.getElementById('topicError');
    const cancelTopic = document.getElementById('cancelTopic');
    const submitTopic = document.getElementById('submitTopic');

    const contestEndPasswordModal = document.getElementById('contestEndPasswordModal');
    const contestEndPasswordInput = document.getElementById('contestEndPasswordInput');
    const contestEndPasswordError = document.getElementById('contestEndPasswordError');
    const cancelContestEndPassword = document.getElementById('cancelContestEndPassword');
    const submitContestEndPassword = document.getElementById('submitContestEndPassword');

    const contestStartVotingPasswordModal = document.getElementById('contestStartVotingPasswordModal');
    const contestStartVotingPasswordInput = document.getElementById('contestStartVotingPasswordInput');
    const contestStartVotingPasswordError = document.getElementById('contestStartVotingPasswordError');
    const cancelContestStartVotingPassword = document.getElementById('cancelContestStartVotingPassword');
    const submitContestStartVotingPassword = document.getElementById('submitContestStartVotingPassword');

    const contestEndVotingPasswordModal = document.getElementById('contestEndVotingPasswordModal');
    const contestEndVotingPasswordInput = document.getElementById('contestEndVotingPasswordInput');
    const contestEndVotingPasswordError = document.getElementById('contestEndVotingPasswordError');
    const cancelContestEndVotingPassword = document.getElementById('cancelContestEndVotingPassword');
    const submitContestEndVotingPassword = document.getElementById('submitContestEndVotingPassword');

    const adminPreviewPasswordModal = document.getElementById('adminPreviewPasswordModal');
    const adminPreviewPasswordInput = document.getElementById('adminPreviewPasswordInput');
    const adminPreviewPasswordError = document.getElementById('adminPreviewPasswordError');
    const cancelAdminPreviewPassword = document.getElementById('cancelAdminPreviewPassword');
    const submitAdminPreviewPassword = document.getElementById('submitAdminPreviewPassword');

    const authBar = document.getElementById('authBar');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const loadingOverlay = document.getElementById('loading-overlay');

    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
    };

    const showAlert = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.add('hidden');
      modalConfirmBtn.textContent = 'í™•ì¸';
      alertModal.classList.remove('hidden');
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => { alertModal.classList.add('hidden'); resolve(true); };
      });
    };

    const showConfirm = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.remove('hidden');
      modalConfirmBtn.textContent = 'ì‚­ì œ';
      alertModal.classList.remove('hidden');
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => { alertModal.classList.add('hidden'); resolve(true); };
        modalCancelBtn.onclick = () => { alertModal.classList.add('hidden'); resolve(false); };
      });
    };

    const openComicViewerModal = (comic) => {
      if (!comic || !comic.images) return;
      modalComicNickname.textContent = comic.uploaderName || 'ìµëª… ì‘ê°€';
      modalComicTopic.textContent = comic.topic ? `ì£¼ì œ: ${comic.topic}` : '';
      modalImageContainer.innerHTML = '';
      comic.images.forEach(imgData => {
        const img = document.createElement('img');
        img.src = imgData.imageUrl;
        img.alt = "ë„¤ì»·ë§Œí™” ì´ë¯¸ì§€";
        img.loading = "lazy";
        modalImageContainer.appendChild(img);
      });
      imageModal.style.display='flex';
    };
    const closeImageModal = () => { imageModal.style.display = 'none'; };

    const openUploadModal = () => {
      if (!window.ensureLogin || !window.ensureLogin(true)) return;
      uploadNickname.value = window.auth?.currentUser?.displayName || '';
      comicFilesInput.value = '';
      imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>';
      uploadModal.style.display = 'flex';
    };
    const closeUploadModal = () => { uploadModal.style.display = 'none'; };

    const handleFilePreview = () => {
      imagePreviewArea.innerHTML = '';
      const files = comicFilesInput.files;
      if (files.length === 0) {
        imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>';
        return;
      }
      const filesToShow = Array.from(files).slice(0, 4);
      filesToShow.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          imagePreviewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    };

    const closeAllPasswordModals = () => {
      contestPasswordModal.style.display = 'none';
      topicModal.style.display = 'none';
      contestEndPasswordModal.style.display = 'none';
      contestStartVotingPasswordModal.style.display = 'none';
      contestEndVotingPasswordModal.style.display = 'none';
      adminPreviewPasswordModal.style.display = 'none';
      [contestPasswordInput, topicInput, contestEndPasswordInput, contestStartVotingPasswordInput, contestEndVotingPasswordInput, adminPreviewPasswordInput].forEach(input => input.value = '');
      [contestPasswordError, topicError, contestEndPasswordError, contestStartVotingPasswordError, contestEndVotingPasswordError, adminPreviewPasswordError].forEach(err => err.textContent = '');
    };

    const attachEventListeners=()=>{
      closeImageModalBtn.addEventListener('click', closeImageModal);
      imageModal.addEventListener('click',(e)=>{ if(e.target === imageModal) closeImageModal(); });
      showUploadModalBtn.addEventListener('click', openUploadModal);
      cancelUploadBtn.addEventListener('click', closeUploadModal);
      submitComicBtn.addEventListener('click', () => { if (window.handleSubmitComic) window.handleSubmitComic(); });
      comicFilesInput.addEventListener('change', handleFilePreview);

      startContestBtn.addEventListener('click', () => {
        if (!window.ensureLogin || !window.ensureLogin(true)) return;
        closeAllPasswordModals();
        contestPasswordModal.style.display = 'flex';
        contestPasswordInput.focus();
      });
      cancelContestPassword.addEventListener('click', closeAllPasswordModals);
      submitContestPassword.addEventListener('click', () => {
        if (contestPasswordInput.value === ADMIN_PASSWORD) {
          contestPasswordModal.style.display = 'none';
          topicModal.style.display = 'flex';
          topicInput.focus();
        } else {
          contestPasswordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });

      cancelTopic.addEventListener('click', closeAllPasswordModals);
      submitTopic.addEventListener('click', () => {
        const topic = topicInput.value.trim();
        if (topic) {
          if (window.setTopicAndStart) window.setTopicAndStart(topic);
          closeAllPasswordModals();
        } else {
          topicError.textContent = 'ì œì‹œì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        }
      });

      endContestBtn.addEventListener('click', () => {
        if (!window.ensureLogin || !window.ensureLogin(true)) return;
        closeAllPasswordModals();
        contestEndPasswordModal.style.display = 'flex';
        contestEndPasswordInput.focus();
      });
      cancelContestEndPassword.addEventListener('click', closeAllPasswordModals);
      submitContestEndPassword.addEventListener('click', () => {
        if (contestEndPasswordInput.value === ADMIN_PASSWORD) {
          if (window.endContestUploadingPhase) window.endContestUploadingPhase();
          closeAllPasswordModals();
        } else {
          contestEndPasswordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });

      startVotingBtn.addEventListener('click', () => {
        if (!window.ensureLogin || !window.ensureLogin(true)) return;
        closeAllPasswordModals();
        contestStartVotingPasswordModal.style.display = 'flex';
        contestStartVotingPasswordInput.focus();
      });
      cancelContestStartVotingPassword.addEventListener('click', closeAllPasswordModals);
      submitContestStartVotingPassword.addEventListener('click', () => {
        if (contestStartVotingPasswordInput.value === ADMIN_PASSWORD) {
          if (window.startVotingPhase) window.startVotingPhase();
          closeAllPasswordModals();
        } else {
          contestStartVotingPasswordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });

      endVotingBtn.addEventListener('click', () => {
        if (!window.ensureLogin || !window.ensureLogin(true)) return;
        closeAllPasswordModals();
        contestEndVotingPasswordModal.style.display = 'flex';
        contestEndVotingPasswordInput.focus();
      });
      cancelContestEndVotingPassword.addEventListener('click', closeAllPasswordModals);
      submitContestEndVotingPassword.addEventListener('click', () => {
        if (contestEndVotingPasswordInput.value === ADMIN_PASSWORD) {
          if (window.endVotingPhase) window.endVotingPhase();
          closeAllPasswordModals();
        } else {
          contestEndVotingPasswordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });

      cancelAdminPreviewPassword.addEventListener('click', closeAllPasswordModals);
      submitAdminPreviewPassword.addEventListener('click', () => {
        if (adminPreviewPasswordInput.value === ADMIN_PASSWORD) {
          closeAllPasswordModals();
          if (window.comicToPreview) {
            openComicViewerModal(window.comicToPreview);
            window.comicToPreview = null;
          }
        } else {
          adminPreviewPasswordError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      });

      signInBtn.onclick = () => doSignIn();
      signOutBtn.onclick = () => signOut(auth);
    };

    const handleTopicSet = (status, topic) => {
      window.currentContestStatus = status || "";
      window.currentTopic = topic || "";
      if (topic && status) {
        currentTopicText.textContent = topic;
        currentTopicDisplay.classList.remove('hidden');
      } else {
        currentTopicDisplay.classList.add('hidden');
      }

      const isLoggedIn = window.isAuthReady && window.auth?.currentUser;
      const isAnonymous = window.auth?.currentUser?.isAnonymous;
      const isManager = isLoggedIn && !isAnonymous;

      startContestBtn.classList.add('hidden');
      showUploadModalBtn.classList.add('hidden');
      endContestBtn.classList.add('hidden');
      startVotingBtn.classList.add('hidden');
      endVotingBtn.classList.add('hidden');

      if (isManager) {
        if (!status) {
          startContestBtn.classList.remove('hidden');
        } else if (status === 'uploading') {
          showUploadModalBtn.classList.remove('hidden');
          endContestBtn.classList.remove('hidden');
        } else if (status === 'upload_ended') {
          startVotingBtn.classList.remove('hidden');
        } else if (status === 'voting') {
          endVotingBtn.classList.remove('hidden');
        }
      }

      renderComics();
    };

    const renderComics = () => {
      if (!comicGrid) return;
      const comicsData = [...(window.comics || [])];

      if (window.currentContestStatus === 'results') {
        comicsData.sort((a, b) => {
          const likesA = Object.keys(a.likes || {}).length;
          const likesB = Object.keys(b.likes || {}).length;
          return likesB - likesA;
        });
      }

      comicGrid.innerHTML = '';

      let ranks = {};
      if (window.currentContestStatus === 'results' && comicsData.length > 0) {
        let currentRank = 0;
        let rankCounter = 0;
        let lastLikeCount = -1;
        comicsData.forEach(comic => {
          const likeCount = Object.keys(comic.likes || {}).length;
          rankCounter++;
          if (likeCount !== lastLikeCount) {
            currentRank = rankCounter;
            lastLikeCount = likeCount;
          }
          if (currentRank <= 3 && likeCount > 0) {
            ranks[comic.id] = currentRank;
          }
        });
      }

      comicsData.forEach(d => {
        const uploaderName = d.uploaderName || 'ìµëª…';
        const likeMap = d.likes || {};
        const likeCount = Object.keys(likeMap).length;
        const imageCount = d.images?.length || 0;
        const currentUserId = window.auth?.currentUser?.uid;
        const userHasLiked = currentUserId && likeMap[currentUserId] === true;
        const status = window.currentContestStatus;
        const likeDisabled = (status === 'uploading' || status === 'upload_ended' || status === 'results');
        const cardClickDisabled = (status === 'uploading');
        const rank = ranks[d.id] || 0;

        const card = document.createElement('div');
        card.className = `comic-card relative group ${cardClickDisabled ? 'disabled' : ''} ${rank > 0 ? `rank-${rank}` : ''}`;
        card.dataset.id = d.id;
        card.innerHTML = `
          ${rank > 0 ? `<div class="rank-medal">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][rank-1]}</div>` : ''}
          <div class="content" data-action="view">
            <span class="nickname-display">${uploaderName}</span>
            <span class="sub-text">${imageCount}ì»· ë§Œí™”</span>
          </div>
          <div class="info-footer">
            <div class="like-section">
              <button class="like-btn ${userHasLiked ? 'liked' : ''} ${likeDisabled ? 'disabled' : ''}" data-id="${d.id}" data-action="like">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 11-3 0v-6zM6 10.333v5.167c0 .83.682 1.5 1.502 1.5h6.666A1.5 1.5 0 0015.5 15.5V8.167A1.5 1.5 0 0014 6.667h-2.167A2.5 2.5 0 009.5 4.5V3.083A1.5 1.5 0 008 1.583 1.5 1.5 0 006.5 3v7.333z" />
                </svg>
                <span>ë”°ë´‰!</span>
              </button>
              <span class="like-count">${likeCount} ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span>
            </div>
          </div>
          ${(currentUserId === d.uploaderId && window.currentContestStatus !== 'results') ? `
          <button class="absolute top-2 right-2 bg-[#424242] text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          ` : ''}
        `;
        comicGrid.appendChild(card);
      });

      comicGrid.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = async (e) => { 
          e.stopPropagation(); 
          const id = e.currentTarget.dataset.id;
          const action = e.currentTarget.dataset.action;
          if (action === 'delete') {
            if (window.deleteComic) await window.deleteComic(id);
          } else if (action === 'like') {
            if (e.currentTarget.classList.contains('disabled')) {
              const status = window.currentContestStatus;
              if (status === 'uploading' || status === 'upload_ended') {
                showAlert('ì•„ì§ íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');
              } else if (status === 'results') {
                showAlert('íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
              }
              return;
            }
            if (window.toggleLike) await window.toggleLike(id);
          }
        };
      });

      comicGrid.querySelectorAll('.comic-card').forEach(card => {
        card.onclick = (e) => {
          if (e.target.closest('button[data-action]')) return;
          const status = window.currentContestStatus;
          if (status === 'uploading') {
            showAlert('ì•„ì§ ë§Œí™”ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì—…ë¡œë“œ ê¸°ê°„)');
            return;
          }
          const id = card.dataset.id;
          const comic = window.comics.find(c => c.id === id);
          if (!comic) return;
          if (status === 'upload_ended') {
            if (!window.ensureLogin || !window.ensureLogin(true)) {
              showAlert('íˆ¬í‘œê°€ ì‹œì‘ë˜ë©´ ë§Œí™”ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }
            window.comicToPreview = comic;
            closeAllPasswordModals();
            adminPreviewPasswordModal.style.display = 'flex';
            adminPreviewPasswordInput.focus();
            return;
          }
          if (status === 'voting' || status === 'results') {
            openComicViewerModal(comic);
          }
        };
      });
    };

    const app = initializeApp(YOUR_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.auth = auth;
    const provider = new GoogleAuthProvider();
    async function doSignIn(){
      try { await signInWithPopup(auth, provider); }
      catch(e){
        console.error("Firebase Auth Error:", e);
        let errorMessage = e.message || e.code;
        if (e.code === 'auth/unauthorized-domain') {
          errorMessage = "ìŠ¹ì¸ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase 'Authentication > ì„¤ì • > ìŠ¹ì¸ëœ ë„ë©”ì¸'ì— ì´ ì›¹ì‚¬ì´íŠ¸ì˜ ë„ë©”ì¸ì„ ì¶”ê°€í•˜ì„¸ìš”.";
        }
        showAlert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + errorMessage);
      }
    }

    window.cloudRefs = () => {
      if (!CANVAS_APP_ID_FOR_FIRESTORE) {
        console.error("ì„¤ì • ì˜¤ë¥˜: CANVAS_APP_ID_FOR_FIRESTORE ê°’ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤!");
        showAlert("ì„¤ì • ì˜¤ë¥˜: CANVAS_APP_ID_FOR_FIRESTOREê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return null;
      }
      return {
        configDoc: doc(db, `artifacts/${CANVAS_APP_ID_FOR_FIRESTORE}/public/data/config/current`),
        comicsCol: collection(db, `artifacts/${CANVAS_APP_ID_FOR_FIRESTORE}/public/data/comics`),
      };
    };

    window.ensureLogin = (requireManager = false) => {
      if (!window.isAuthReady) { showAlert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.'); return false; }
      if (!auth.currentUser) { showAlert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.'); return false; }
      if (requireManager && auth.currentUser.isAnonymous) {
        showAlert('ì½˜í…ì¸ ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê´€ë¦¬í•˜ë ¤ë©´ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤. (ìš°ì¸¡ ìƒë‹¨ ë¡œê·¸ì¸ ë²„íŠ¼)');
        return false;
      }
      return true;
    };

    const uploadToImgBB = async (fileOrUrl) => {
      if (IMGBB_API_KEY === "REPLACE_WITH_IMGBB_API_KEY" || !IMGBB_API_KEY) {
         throw new Error('ImgBB API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      const form = new FormData();
      form.append('image', fileOrUrl);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: form });
      const json = await res.json();
      if (!json.success) { throw new Error(json?.error?.message || 'ImgBB ì—…ë¡œë“œ ì‹¤íŒ¨'); }
      return { imageUrl: json.data?.url || json.data?.display_url, deleteUrl: json.data?.delete_url || null };
    };

    window.handleSubmitComic = async () => {
      if (!ensureLogin(true)) return;
      const nickname = document.getElementById('uploadNickname').value.trim();
      const files = document.getElementById('comicFilesInput').files;
      if (!nickname) { showAlert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if (files.length === 0) { showAlert('í•˜ë‚˜ ì´ìƒì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      if (!window.currentTopic) { showAlert('í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ëŒ€ì „ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const filesToUpload = Array.from(files).slice(0, 4);
      loadingOverlay.classList.remove('hidden');
      showFeedbackMessage(`ë§Œí™” ${filesToUpload.length}ì¥ ì—…ë¡œë“œ ì¤‘...`);
      try {
        const refs = cloudRefs();
        if (!refs) return;
        const uploadPromises = filesToUpload.map(file => uploadToImgBB(file));
        const uploadedImagesData = await Promise.all(uploadPromises);
        await addDoc(refs.comicsCol, {
          images: uploadedImagesData,
          uploaderId: auth.currentUser.uid,
          uploaderName: nickname,
          uploaderDisplayName: auth.currentUser.displayName || 'ìµëª…',
          topic: window.currentTopic,
          timestamp: serverTimestamp(),
          likes: {}
        });
        loadingOverlay.classList.add('hidden');
        showFeedbackMessage('ë§Œí™”ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        if(typeof closeUploadModal === 'function') closeUploadModal();
      } catch (err) {
        loadingOverlay.classList.add('hidden');
        showAlert('ë§Œí™” ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || 'ì˜¤ë¥˜'));
      }
    };

    window.deleteComic = async (id)=>{
      if(!ensureLogin(true)) return;
      try{
        const comic = (window.comics||[]).find(d=>d.id===id);
        if(!comic) throw new Error('ë§Œí™” í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        if(comic.uploaderId !== auth.currentUser.uid) { showAlert('ìì‹ ì´ ì˜¬ë¦° ë§Œí™”ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
        if (!(await showConfirm('ì •ë§ë¡œ ì´ ë§Œí™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))) return;
        const refs = cloudRefs();
        if (!refs) return;
        try {
          if(comic.images && Array.isArray(comic.images)){
            const deletePromises = comic.images
              .filter(img => img.deleteUrl)
              .map(img => fetch(img.deleteUrl, { method: 'GET' }).catch(e => console.error("ImgBB ì‚­ì œ ì˜¤ë¥˜:", e)));
            await Promise.allSettled(deletePromises);
          }
        } catch(e) { console.warn("ImgBB ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œí•¨):", e); }
        await deleteDoc(doc(refs.comicsCol, id));
        showFeedbackMessage('ë§Œí™”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(e){
        showAlert('ë§Œí™” ì‚­ì œ ì¤‘ ì˜¤ë¥˜: '+(e?.message||'unknown'));
      }
    };

    window.toggleLike = async (id) => {
      if (!ensureLogin(false)) return;
      const userId = auth.currentUser.uid;
      const refs = cloudRefs();
      if (!refs) return;
      const comicRef = doc(refs.comicsCol, id);
      const comic = window.comics.find(c => c.id === id);
      if (!comic) return;
      const userHasLiked = (comic.likes || {})[userId] === true;
      try {
        if (userHasLiked) {
          await updateDoc(comicRef, { [`likes.${userId}`]: deleteField() });
        } else {
          await updateDoc(comicRef, { [`likes.${userId}`]: true });
        }
      } catch (e) {
        console.error("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showAlert("ì¢‹ì•„ìš” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    const updateContestConfig = async (topic, status) => {
      if (!ensureLogin(true)) return;
      try {
        const refs = cloudRefs();
        if (!refs) return;
        await setDoc(refs.configDoc, { topic: topic, status: status, updatedAt: serverTimestamp() }, { merge: true });
      } catch (e) {
        showAlert('ëŒ€ì „ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.message);
      }
    };

    window.setTopicAndStart = async (topic) => { await updateContestConfig(topic, 'uploading'); showFeedbackMessage('ëŒ€ì „ì„ ì‹œì‘í•©ë‹ˆë‹¤! (ì—…ë¡œë“œ ê¸°ê°„)'); };
    window.endContestUploadingPhase = async () => { await updateContestConfig(window.currentTopic, 'upload_ended'); showFeedbackMessage('ë§Œí™” ì—…ë¡œë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); };
    window.startVotingPhase = async () => { await updateContestConfig(window.currentTopic, 'voting'); showFeedbackMessage('íˆ¬í‘œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!'); };
    window.endVotingPhase = async () => { await updateContestConfig(window.currentTopic, 'results'); showFeedbackMessage('íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê²°ê³¼ë¥¼ ë°œí‘œí•©ë‹ˆë‹¤.'); };

    window.__unsubs=[];
    async function setupRealtimeSync(){
      const refs = cloudRefs();
      if (!refs) return;
      window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} });
      window.__unsubs=[];
      const unsubConfig = onSnapshot(refs.configDoc, (doc) => {
        const data = doc.data();
        const status = data?.status || "";
        const topic = data?.topic || "";
        if(typeof handleTopicSet === 'function') { handleTopicSet(status, topic); }
      }, (error) => {
        console.error("Config êµ¬ë… ì˜¤ë¥˜:", error);
        if (error.code === 'permission-denied') {
          showAlert("ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”. ('config' ì»¬ë ‰ì…˜ì— ëŒ€í•œ 'read: true' ì„¤ì • í•„ìš”)");
        }
      });
      window.__unsubs.push(unsubConfig);

      const q = query(refs.comicsCol, orderBy("timestamp", "desc"), limit(100));
      const unsubComics = onSnapshot(q, (snap) => {
          window.comics = snap.docs.map(d=>({id:d.id,...d.data()}));
          if(typeof renderComics === 'function') renderComics();
      }, (error) => {
        console.error("Comics êµ¬ë… ì˜¤ë¥˜:", error);
        if (error.code === 'permission-denied') {
          showAlert("ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”. ('comics' ì»¬ë ‰ì…˜ì— ëŒ€í•œ 'read: true' ì„¤ì • í•„ìš”)");
        }
      });
      window.__unsubs.push(unsubComics);
    }

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden');
      window.isAuthReady=false;
      let currentUser = user;
      if (!user) {
        try {
          const userCredential = await signInAnonymously(auth);
          currentUser = userCredential.user;
          console.log("Web: ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ");
        } catch (e) { console.error("Web: ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨", e); }
      }

      if(currentUser){
        authBar.classList.remove('hidden');
        if (currentUser.isAnonymous) {
          userInfoEl.textContent = 'ìµëª… ì‚¬ìš©ì';
          signInBtn.classList.remove('hidden');
          signOutBtn.classList.add('hidden');
        } else {
          userInfoEl.textContent = `${currentUser.displayName || 'ë¡œê·¸ì¸ë¨'}`;
          signInBtn.classList.add('hidden');
          signOutBtn.classList.remove('hidden');
        }
        await setupRealtimeSync();
      } else {
        authBar.classList.remove('hidden');
        userInfoEl.textContent='';
        signOutBtn.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} });
        window.__unsubs=[];
        window.comics=[];
        if(typeof handleTopicSet === 'function') handleTopicSet("", "");
      }

      loadingOverlay.classList.add('hidden');
      window.isAuthReady=true;
      if(typeof handleTopicSet === 'function') {
         handleTopicSet(window.currentContestStatus, window.currentTopic);
      }
    });

    (function init(){ attachEventListeners(); })();

  </script>
</body>
</html>
