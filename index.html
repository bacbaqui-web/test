<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>네컷만화대전</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem; /* 콘텐츠 간 간격 추가 */
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px; /* 더 넓은 갤러리를 위해 최대 너비 증가 */
    }
    .drag-area {
      border: 2px dashed #4b4b4b;
      transition: all .3s ease;
      padding: 24px;
    }
    .drag-area.active {
      border-color: #6b6b6b;
      background-color: #2a2a2a;
    }
    
    /* 네컷만화 Masonry 레이아웃 */
    #comic-grid {
      column-count: 2; /* 기본 2열 */
      column-gap: 1rem;
      margin-top: 1.5rem; /* mt-6 */
      display: block;
    }
    @media (min-width: 640px) { /* sm: 3열 */
      #comic-grid { column-count: 3; }
    }
    @media (min-width: 1024px) { /* lg: 4열 */
      #comic-grid { column-count: 4; }
    }
    @media (min-width: 1280px) { /* xl: 5열 */
      #comic-grid { column-count: 5; }
    }

    /* 네컷만화 카드 스타일 (북마크 카드에서 가져옴) */
    .comic-card {
      position: relative;
      transition: transform .2s ease-in-out; 
      background: #333; 
      border-radius: 8px; 
      overflow: hidden; 
      margin-bottom: 1rem; /* 세로 간격 */
      break-inside: avoid; /* 카드 분할 방지 */
      width: 100%;
      display: block;
    }
    .comic-card:hover {
      transform: translateY(-5px);
    }
    
    .comic-card .content {
      display: block; 
      width: 100%;
      height: auto;
      overflow: hidden;
      background-color: #1a1a1a;
      min-height: 80px; 
      position: relative;
    }
    
    .comic-card img {
      position: static; 
      width: 100%;
      height: auto; /* 실제 비율 사용 */
      display: block;
      object-fit: contain; 
    }

    /* 카드 하단 정보 (업로더, 좋아요) */
    .comic-card .info-footer {
      padding: 12px;
      background: #333;
      text-align: left;
    }

    .comic-card .uploader-name {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .comic-card .like-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* 따봉 버튼 스타일 */
    .like-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #555;
      color: white;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 700;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
    }
    /* 사용자가 이미 좋아요 누른 버튼 스타일 */
    .like-btn.liked {
      background: #2563eb; /* Tailwind blue-600 */
      color: white;
    }

    .like-btn:hover:not(.liked) {
      background: #666;
    }
    
    .like-count {
      font-size: 0.9rem;
      font-weight: 700;
      color: #ddd;
    }


    /* 이미지 모달 스타일 */
    #imageModal.modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #imageModal .modal-content {
      background-color: transparent; padding: 0; box-shadow: none;
      max-width: 90vw; max-height: 90vh;
      width: auto; height: auto; 
      display: flex; justify-content: center; align-items: center;
      cursor: pointer;
    }
    #modalImage {
      width: auto; height: auto; 
      max-width: 100%; max-height: 100%;
      object-fit: contain;
    }
    
    @media (max-width:768px){
      body{padding:12px;gap:0.5rem}.section-card{padding:12px;border-radius:0}
    }
  </style>
</head>
<body class="text-white">

  <!-- 로그인 바 (그대로 유지) -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2 mb-2">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google 로그인</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">로그아웃</button>
  </div>

  <!-- 메인 타이틀 -->
  <h1 class="text-3xl font-bold text-center text-white">
    <span class="text-blue-400">네컷만화</span>
    <span class="text-white">대전</span>
    <span class="text-red-400">!</span>
  </h1>

  <!-- 만화 업로드 및 갤러리 섹션 -->
  <div id="comics-section" class="section-card text-left">
    
    <section id="drag-area" class="drag-area rounded-lg p-6 flex items-center justify-center text-center text-[#999] font-medium cursor-pointer" title="클릭하면 클립보드에서 자동 붙여넣기 시도">
      <div>
        <p class="text-lg">여기에 네컷만화 이미지를 드래그 앤 드롭 하세요.</p>
        <p class="text-sm">또는, 캡쳐/이미지 붙여넣기(Ctrl/Cmd+V) 혹은 클릭 (클립보드 붙여넣기)도 가능합니다.</p>
        <p class="text-xs text-gray-500 mt-2">(로그인 한 사용자만 업로드할 수 있습니다)</p>
      </div>
    </section>
    
    <!-- 네컷만화 갤러리 그리드 -->
    <section id="comic-grid"></section>
  </div>


  <!-- 이미지 확대 모달 -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img id="modalImage" src="" alt="확대 이미지" />
      <!-- 원본 페이지 이동 버튼 제거 -->
    </div>
  </div>

  <!-- 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-lg text-center font-medium"></p>
      <div class="mt-4 flex justify-center">
        <button id="modal-close-btn" class="px-4 py-2 bg-[#424242] text-white rounded-md hover:bg-[#525252]">확인</button>
      </div>
    </div>
  </div>

  <!-- 로딩 오버레이 -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-4 text-lg">데이터를 불러오는 중...</p>
    </div>
  </div>

  <!-- ===== UI 스크립트 ===== -->
  <script>
    // ImgBB API Key (이미지 업로드용)
    const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

    // 전역 상태
    window.comics = []; // 'imageBookmarks' 대신 'comics' 사용
    window.isAuthReady = false;

    // DOM 요소
    const dragArea = document.getElementById('drag-area');
    const comicGrid = document.getElementById('comic-grid');
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');


    // 유틸리티 함수
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
    };
    const showAlert = (msg) => { document.getElementById('modal-message').textContent = msg; document.getElementById('alert-modal').classList.remove('hidden'); };
    const hideAlert = () => { document.getElementById('alert-modal').classList.add('hidden'); };
    document.getElementById('modal-close-btn').addEventListener('click', hideAlert);

    // 'pageUrl' 인자 제거 (네컷만화는 원본 페이지가 없음)
    const openImageModal = (imageUrl) => {
      modalImage.src = imageUrl;
      imageModal.style.display='flex';
    };
    const closeImageModal = () => { imageModal.style.display = 'none'; };

    // 이벤트 리스너 부착
    const attachEventListeners=()=>{
      closeImageModalBtn.addEventListener('click', closeImageModal);
      imageModal.addEventListener('click',(e)=>{ if(e.target===imageModal) closeImageModal(); }); 
      document.querySelector('#imageModal .modal-content').addEventListener('click', (e) => {
          if (!e.target.closest('#closeImageModalBtn')) {
              closeImageModal();
          }
      });
    };

    // 네컷만화 갤러리 렌더링
    // (renderImageBookmarks 함수를 'renderComics'로 이름 변경 및 수정)
    const renderComics = () => {
      if (!comicGrid) return;
      comicGrid.innerHTML = '';
      
      // 'window.comics'는 onSnapshot에서 실시간으로 업데이트됨 (기본 최신순 정렬)
      const sortedComics = [...(window.comics || [])];

      sortedComics.forEach(d => {
        const imageUrl = d.imageUrl;
        const uploaderName = d.uploaderName || '익명';
        const likeMap = d.likes || {};
        const likeCount = Object.keys(likeMap).length;
        
        // 현재 로그인한 사용자가 좋아요를 눌렀는지 확인
        const currentUserId = window.auth?.currentUser?.uid;
        const userHasLiked = currentUserId && likeMap[currentUserId] === true;

        const card = document.createElement('div');
        card.className = 'comic-card relative group';
        
        card.innerHTML = `
          <div class="content cursor-pointer" data-action="view">
            <img src="${imageUrl}" alt="네컷만화" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='https://placehold.co/400x400/444/fff?text=이미지+오류'"/>
          </div>
          <div class="info-footer">
            <div class="uploader-name">${uploaderName} 님</div>
            <div class="like-section">
              <!-- 따봉 버튼 -->
              <button class="like-btn ${userHasLiked ? 'liked' : ''}" data-id="${d.id}" data-action="like">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 11-3 0v-6zM6 10.333v5.167c0 .83.682 1.5 1.502 1.5h6.666A1.5 1.5 0 0015.5 15.5V8.167A1.5 1.5 0 0014 6.667h-2.167A2.5 2.5 0 009.5 4.5V3.083A1.5 1.5 0 008 1.583 1.5 1.5 0 006.5 3v7.333z" />
                </svg>
                <span>따봉!</span>
              </button>
              <!-- 좋아요 카운트 -->
              <span class="like-count">${likeCount} 명이 좋아합니다</span>
            </div>
          </div>
          
          <!-- 삭제 버튼 (자신이 올린 만화인 경우에만 표시) -->
          ${currentUserId === d.uploaderId ? `
          <button class="absolute top-2 right-2 bg-[#424242] text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          ` : ''}
        `;
        comicGrid.appendChild(card);
      });
      
      // 버튼 이벤트 리스너 부착
      comicGrid.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = async (e) => { 
          e.stopPropagation(); 
          const id = e.currentTarget.dataset.id;
          const action = e.currentTarget.dataset.action;

          if (action === 'delete') {
            if (window.deleteComic) await window.deleteComic(id);
          } else if (action === 'like') {
            if (window.toggleLike) await window.toggleLike(id);
          }
        };
      });

      // 이미지 클릭 이벤트 (확대)
      comicGrid.querySelectorAll('.content[data-action="view"]').forEach(el => {
        el.onclick = (e) => {
          e.stopPropagation();
          const img = el.querySelector('img');
          if (img && img.src) {
            openImageModal(img.src);
          }
        };
      });
    };


    (function init(){ 
      attachEventListeners(); 
      // 달력 렌더링 제거
    })();

    // ===== D&D/붙여넣기/클릭-자동붙여넣기 =====
    function isImageUrl(u){
      try{ new URL(u); }catch{ return false; }
      return /\.(jpe?g|png|gif|webp|svg|avif)(\?|$)/i.test(u);
    }
    
    // (동영상, 링크, 인스타그램 관련 함수 제거 - 네컷만화(이미지)에만 집중)

    // 드래그앤드롭 핸들러
    dragArea.addEventListener('dragover',(e)=>{ e.preventDefault(); dragArea.classList.add('active'); });
    dragArea.addEventListener('dragleave',()=>{ dragArea.classList.remove('active'); });
    dragArea.addEventListener('drop',async(e)=>{
      e.preventDefault(); dragArea.classList.remove('active');
      const dt = e.dataTransfer;
      
      // 1. 파일 드롭 처리 (이미지 파일만)
      const files=[...(dt.files||[])].filter(f=>f.type.startsWith('image/'));
      if(files.length > 0){
        if(window.addImage) {
          await window.addImage(files[0]); // 첫 번째 이미지만 업로드
          showFeedbackMessage('만화가 업로드되었습니다!');
          return;
        }
      }

      // 2. HTML/텍스트에서 이미지 URL 추출 시도
      const html = dt.getData('text/html');
      const plainText = dt.getData('text/plain');
      let url = null;

      if(html){
        const doc=new DOMParser().parseFromString(html,'text/html');
        const img=doc.querySelector('img');
        if(img?.src){ url=img.src; }
      }
      if(!url){ const u=dt.getData('text/uri-list')||dt.getData('URL')||plainText; if(u) { url=u; } }

      // 3. 이미지 URL인 경우 처리
      if(url && isImageUrl(url)){
        // 원격 이미지 URL을 ImgBB로 프록시 업로드 (CORS 등 이슈 방지)
        if(window.addImage){ 
          await window.addImage(url); 
          showFeedbackMessage('만화가 업로드되었습니다!'); 
        } 
        return; 
      }

      showAlert('유효한 이미지 파일을 찾지 못했습니다.');
    });

    // 클릭: 클립보드 접근 및 자동 붙여넣기 시도
    dragArea.addEventListener('click', async ()=>{
      if (!window.ensureLogin || !window.ensureLogin()) return;
      try{
        let processed = false;
        
        // 1. 클립보드 이미지 처리
        if(navigator.clipboard?.read){
          const items=await navigator.clipboard.read();
          for(const it of items){
            for(const type of it.types){
              if(type.startsWith('image/')){
                const blob=await it.getType(type);
                if(window.addImage){ 
                  await window.addImage(new File([blob],'clipboard-image',{type:blob.type})); 
                  showFeedbackMessage('클립보드 이미지 업로드됨'); 
                  processed=true; 
                  return; 
                }
              }
            }
          }
        }
        
        // 2. 클립보드 텍스트 (이미지 URL) 처리
        const t = await navigator.clipboard.readText();
        if(t && isImageUrl(t)){ 
            if(window.addImage){ 
              await window.addImage(t); 
              showFeedbackMessage('클립보드 이미지 URL 업로드됨'); 
              processed=true; 
              return; 
            } 
        }
        
        if(!processed) showAlert('클립보드에서 유효한 이미지를 읽지 못했습니다.');
      }catch(e){ console.error(e); showAlert('클립보드 권한을 허용하세요.'); }
    });

    // 붙여넣기 핸들러
    dragArea.addEventListener('paste', async (e)=>{
      if (!window.ensureLogin || !window.ensureLogin()) return;
      e.preventDefault();
      const items=[...(e.clipboardData||e.originalEvent?.clipboardData)?.items||[]];

      for(const item of items){
        // 1. 이미지 파일 처리
        if(item.kind==='file' && item.type.startsWith('image/')){
          const file=item.getAsFile(); 
          if(file && window.addImage){ 
            await window.addImage(file); 
            showFeedbackMessage('이미지 업로드됨'); 
            return; 
          }
        }
        // 2. 텍스트 (이미지 URL) 처리
        if(item.kind==='string'){
          const txt=await new Promise(r=>item.getAsString(r));
          if(txt && isImageUrl(txt)){
             if(window.addImage){ 
                await window.addImage(txt); 
                showFeedbackMessage('URL 업로드됨'); 
                return; 
             } 
          }
        }
      }
      
      showAlert('붙여넣기한 항목에 유효한 이미지가 없습니다.');
    });
  </script>

  <!-- ===== Firebase & 동기화 ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // 필요한 Firestore 모듈 추가
    import { 
      getFirestore, doc, deleteDoc, collection, onSnapshot, 
      addDoc, updateDoc, serverTimestamp, query, orderBy, 
      limit, deleteField 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Config (원래 파일에서 가져옴)
    const firebaseConfig = {
      apiKey: "AIzaSyCiwzde40jsz17CEz-rrMmmBrn-S6brdlE",
      authDomain: "comicschedule-dfec7.firebaseapp.com",
      projectId: "comicschedule-dfec7",
      storageBucket: "comicschedule-dfec7.appspot.com",
      messagingSenderId: "1084611276816",
      appId: "1:1084611276816:web:aca83237bafa971ed1fa95",
      measurementId: "G-ZNZZQRJZF9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // auth 객체를 window에 할당하여 renderComics에서 사용자 ID를 참조할 수 있도록 함
    window.auth = auth;

    const signInBtn=document.getElementById('signInBtn');
    const signOutBtn=document.getElementById('signOutBtn');
    const userInfoEl=document.getElementById('userInfo');
    const loadingOverlay=document.getElementById('loading-overlay');
    const provider = new GoogleAuthProvider();

    async function doSignIn(){
      try{ await signInWithPopup(auth,provider); }
      catch(e){
        if(e.code==='auth/popup-blocked'||e.code==='auth/unauthorized-domain'){ await signInWithRedirect(auth,provider); }
        else{ document.getElementById('modal-message').textContent='로그인 오류: '+(e.message||e.code); document.getElementById('alert-modal').classList.remove('hidden'); }
      }
    }
    getRedirectResult(auth).catch(()=>{});

    signInBtn.onclick=()=>doSignIn();
    signOutBtn.onclick=()=>signOut(auth);

    // 공용 'comics' 컬렉션 참조
    window.cloudRefs = () => {
      // 중요: 'comics' 컬렉션은 모든 사용자가 읽을 수 있어야 합니다.
      // Firebase > Firestore > Rules에서 다음 규칙을 추가해야 합니다:
      // rules_version = '2';
      // service cloud.firestore {
      //   match /databases/{database}/documents {
      //     // ... (기존 users 규칙)
      //
      //     // 'comics' 컬렉션 규칙
      //     match /comics/{comicId} {
      //       allow read: if true;
      //       allow create: if request.auth != null;
      //       allow update, delete: if request.auth.uid == resource.data.uploaderId || request.auth != null; // '좋아요'는 누구나, 삭제는 본인만
      //     }
      //   }
      // }
      // (update 규칙을 '좋아요'에 맞게 더 세분화할 수 있습니다)
      return {
        comicsCol: collection(db, "comics"),
      };
    };

    window.ensureLogin=()=>{
      if(!window.isAuthReady){ showAlert('데이터 로딩 중입니다.'); return false; }
      if(!auth.currentUser){ showAlert('로그인 후 이용해 주세요.'); return false; }
      return true;
    };

    // (달력/메모 관련 저장 함수 제거)

    // ===== 네컷만화 업로드 및 관리 =====
    
    // imgbb 업로드(붙여넣기/클립보드/드래그 이미지 전용)
    window.addImage = async (fileOrUrl)=>{
      if(!ensureLogin()) return;
      try{
        const { comicsCol } = cloudRefs();
        
        const form = new FormData();
        // fileOrUrl이 string (URL)인 경우, 프록시 업로드를 위해 'image' 파라미터에 URL을 할당
        form.append('image', fileOrUrl); 
        
        showFeedbackMessage('이미지 업로드 중...');

        const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST',body:form});
        const json=await res.json();
        if(!json.success) throw new Error(json?.error?.message || 'imgbb 업로드 실패');
        
        const link=json.data?.url || json.data?.display_url;
        const deleteUrl=json.data?.delete_url || null;

        // Firestore에 네컷만화 정보 저장
        await addDoc(comicsCol, {
          imageUrl: link,
          imgbb_delete_url: deleteUrl, // 나중에 삭제할 수 있도록 삭제 URL 저장
          uploaderId: auth.currentUser.uid,
          uploaderName: auth.currentUser.displayName || '익명',
          timestamp: serverTimestamp(), // 정렬을 위한 서버 시간
          likes: {} // '좋아요'를 위한 빈 맵
        });

        showFeedbackMessage('만화가 등록되었습니다!');

      }catch(err){
        showAlert('이미지 추가 실패: '+(err.message||'오류'));
      }
    };

    // 네컷만화 삭제
    window.deleteComic = async (id)=>{
      if(!ensureLogin()) return;
      try{
        // window.comics는 onSnapshot을 통해 실시간으로 업데이트됨
        const comic = (window.comics||[]).find(d=>d.id===id); 
        if(!comic) throw new Error('만화 항목을 찾을 수 없습니다.');
        
        // 본인만 삭제 가능
        if(comic.uploaderId !== auth.currentUser.uid) {
          showAlert('자신이 올린 만화만 삭제할 수 있습니다.');
          return;
        }

        if (!confirm('정말로 이 만화를 삭제하시겠습니까?')) return;

        const { comicsCol } = cloudRefs();
        
        // (선택사항) ImgBB 이미지 삭제 시도
        if(comic.imgbb_delete_url){ 
          try{ await fetch(comic.imgbb_delete_url, {method:'GET'}); }
          catch(_){ /* imgbb 삭제 오류는 무시 */ } 
        }
        
        // Firestore 문서 삭제
        await deleteDoc(doc(comicsCol, id));
        showFeedbackMessage('만화가 삭제되었습니다.');

      }catch(e){
        showAlert('만화 삭제 중 오류: '+(e?.message||'unknown'));
      }
    };

    // '따봉' (좋아요) 토글 기능
    window.toggleLike = async (id) => {
      if (!ensureLogin()) return;

      const userId = auth.currentUser.uid;
      const comicRef = doc(db, 'comics', id);
      
      // onSnapshot이 실시간으로 업데이트하므로, 로컬 데이터를 참조하여 현재 상태 확인
      const comic = window.comics.find(c => c.id === id);
      if (!comic) return;

      const userHasLiked = (comic.likes || {})[userId] === true;
      
      try {
        // Dot notation을 사용하여 맵의 특정 필드만 원자적으로 업데이트/삭제
        if (userHasLiked) {
          // 이미 좋아한 경우: '좋아요' 취소 (필드 삭제)
          await updateDoc(comicRef, {
            [`likes.${userId}`]: deleteField()
          });
        } else {
          // 좋아하지 않은 경우: '좋아요' 추가
          await updateDoc(comicRef, {
            [`likes.${userId}`]: true
          });
        }
      } catch (e) {
        console.error("좋아요 업데이트 오류:", e);
        showAlert("좋아요 상태를 업데이트하는 중 오류가 발생했습니다.");
      }
    };

    // ===== 실시간 동기화 =====
    window.__unsubs=[];
    async function setupRealtimeSync(){
      // 로그인 시 공용 'comics' 컬렉션을 구독
      const { comicsCol } = cloudRefs();
      
      window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); 
      window.__unsubs=[];

      // 최신 100개 만화를 시간순(내림차순)으로 가져오는 쿼리
      const q = query(comicsCol, orderBy("timestamp", "desc"), limit(100));

      const unsubComics = onSnapshot(q, (snap) => { 
          window.comics = snap.docs.map(d=>({id:d.id,...d.data()})); 
          if(typeof renderComics === 'function') renderComics(); 
      });
      window.__unsubs.push(unsubComics);
    }

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden'); 
      window.isAuthReady=false;
      
      if(user){
        // 로그인 성공
        userInfoEl.textContent = `${user.displayName || '로그인됨'} (${user.email || ''})`;
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        // 공용 만화 갤러리 실시간 구독 시작
        await setupRealtimeSync();
      }else{
        // 로그아웃
        userInfoEl.textContent=''; 
        signOutBtn.classList.add('hidden'); 
        signInBtn.classList.remove('hidden');
        
        // 실시간 구독 해제
        window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); 
        window.__unsubs=[];
        
        // 갤러리 비우기
        window.comics=[];
        if(typeof renderComics==='function') renderComics(); 
      }
      
      loadingOverlay.classList.add('hidden'); 
      window.isAuthReady=true;
      
      // (중요) 로그인/로그아웃 시 UI가 변경되어야 하므로 renderComics()를 다시 호출
      if(typeof renderComics==='function') renderComics();
    });
  </script>
</body>
</html>
