<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì œ2íšŒ ë„¤ì»·ë§Œí™”ëŒ€ì „</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      flex-direction: column;
      gap: 1rem;
    }
    .section-card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
      text-align: center;
      width: 100%;
      max-width: 1200px;
    }
    
    #comic-grid {
      column-count: 2; column-gap: 1rem; margin-top: 1.5rem; display: block;
    }
    @media (min-width: 640px) { #comic-grid { column-count: 3; } }
    @media (min-width: 1024px) { #comic-grid { column-count: 4; } }
    @media (min-width: 1280px) { #comic-grid { column-count: 5; } }

    .comic-card {
      position: relative; transition: all .2s ease-in-out; 
      background: #333; border-radius: 12px; 
      overflow: hidden; margin-bottom: 1rem; 
      break-inside: avoid; width: 100%;
      display: block; cursor: pointer;
      border: 3px solid transparent; /* ë“±ìˆ˜ í…Œë‘ë¦¬ë¥¼ ìœ„í•œ ê³µê°„ */
    }
    .comic-card:hover:not(.disabled) { transform: translateY(-5px); background: #444; }
    
    .comic-card.disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
    .comic-card.disabled:hover { transform: none; background: #333; }

    /* 1. ë“±ìˆ˜ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .comic-card.rank-1 { border-color: #FFD700; background: #4d401e; }
    .comic-card.rank-2 { border-color: #C0C0C0; background: #474747; }
    .comic-card.rank-3 { border-color: #CD7F32; background: #4d3a2a; }
    
    .rank-medal {
      position: absolute;
      top: -10px;
      left: -10px;
      font-size: 2.5rem; /* 40px */
      line-height: 1;
      transform: rotate(-15deg);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .comic-card .content {
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; width: 100%; min-height: 120px; 
      padding: 16px; text-align: center;
      background-color: #1a1a1a; position: relative;
    }
    
    .comic-card .nickname-display {
      font-size: 1.25rem; font-weight: 700; color: #fff; word-break: break-all;
    }
    .comic-card .sub-text { font-size: 0.8rem; color: #aaa; margin-top: 4px; }
    
    /* ì¹´ë“œì—ì„œ ì œì‹œì–´ í‘œì‹œ ì œê±°ë¨ */
    
    .comic-card img { display: none; }

    .comic-card .info-footer { padding: 12px; background: #333; text-align: left; }
    /* ë“±ìˆ˜ í‘œì‹œ ì‹œ ë­í¬ ìƒ‰ìƒê³¼ ë§ì¶”ê¸° */
    .comic-card.rank-1 .info-footer { background: #4d401e; }
    .comic-card.rank-2 .info-footer { background: #474747; }
    .comic-card.rank-3 .info-footer { background: #4d3a2a; }

    .comic-card .like-section { display: flex; justify-content: space-between; align-items: center; }

    .like-btn {
      display: flex; align-items: center; gap: 6px;
      background: #555; color: white; padding: 6px 10px;
      border-radius: 20px; font-size: 0.9rem; font-weight: 700;
      transition: all 0.2s ease; cursor: pointer; border: none;
    }
    .like-btn.liked { background: #2563eb; color: white; }
    .like-btn:hover:not(.liked):not(.disabled) { background: #666; }
    .like-count { font-size: 0.9rem; font-weight: 700; color: #ddd; }
    
    .like-btn.disabled {
      background: #444; color: #888; cursor: not-allowed;
    }
    .like-btn.disabled:hover { background: #444; }


    #imageModal.modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #imageModal .modal-content {
      background-color: #1a1a1a; padding: 1.5rem; 
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      border-radius: 12px; max-width: 90vw; max-height: 90vh;
      width: auto; height: auto; display: flex;
      flex-direction: column; justify-content: flex-start; 
      align-items: center; cursor: default; overflow-y: auto;
    }
    
    #modalComicNickname {
      font-size: 1.5rem; font-weight: 700; color: #fff;
      margin-bottom: 0.5rem; width: 100%; text-align: center;
    }
    
    #modalComicTopic {
      font-size: 1.1rem; font-weight: 700; color: #34d399; /* emerald-400 */
      margin-bottom: 1rem; padding-bottom: 0.5rem;
      border-bottom: 2px solid #444;
      width: 100%; text-align: center;
    }

    #modalImageContainer {
      display: flex; flex-direction: column; gap: 10px;
      width: 100%; max-width: 500px;
    }
    #modalImageContainer img {
      width: 100%; height: auto; display: block; border-radius: 8px;
    }
    #modalImage { display: none; }
    
    /* ì—…ë¡œë“œ ëª¨ë‹¬ */
    #uploadModal {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #uploadModal .modal-content {
      background: #2a2a2a; border-radius: 12px;
      padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.5);
      width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    }
    #imagePreviewArea {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
      margin-top: 1rem; padding: 10px; background: #1a1a1a;
      border-radius: 8px; min-height: 100px;
    }
    .preview-image {
      width: 100%; height: auto; object-fit: cover;
      border-radius: 4px; aspect-ratio: 1 / 1;
    }
    .file-input-label {
      background: #444; color: white; padding: 10px 15px;
      border-radius: 8px; cursor: pointer; text-align: center;
      font-weight: 700; transition: background .2s;
    }
    .file-input-label:hover { background: #555; }
    #comicFilesInput { display: none; }
    
    /* ê´€ë¦¬ì ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #startContestBtn { /* ëŒ€ì „ ì‹œì‘ */
      background: #10b981; color: white; font-weight: 700;
      padding: 12px 24px; border-radius: 8px; font-size: 1.1rem;
      transition: all .2s ease; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
    }
    #startContestBtn:hover { background: #059669; transform: translateY(-2px); }
    
    #endContestBtn { /* ì˜¬ë¦¬ê¸° ì¢…ë£Œ */
      background: #ef4444; color: white; font-weight: 700;
      padding: 10px 20px; border-radius: 8px; font-size: 1.0rem;
      transition: all .2s ease; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
    }
    #endContestBtn:hover { background: #dc2626; }
    
    #startVotingBtn { /* íˆ¬í‘œ ì‹œì‘ */
      background: #3b82f6; /* blue-500 */ color: white; font-weight: 700;
      padding: 10px 20px; border-radius: 8px; font-size: 1.0rem;
      transition: all .2s ease; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
    }
    #startVotingBtn:hover { background: #2563eb; }
    
    #endVotingBtn { /* 2. íˆ¬í‘œ ì¢…ë£Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      background: #8b5cf6; /* violet-500 */ color: white; font-weight: 700;
      padding: 10px 20px; border-radius: 8px; font-size: 1.0rem;
      transition: all .2s ease; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
    }
    #endVotingBtn:hover { background: #7c3aed; }
    
    
    #contestTopicDisplay {
      font-size: 1.25rem; font-weight: 700; color: #34d399; /* emerald-400 */
      margin-top: 0.5rem; padding: 8px 16px;
      background-color: rgba(52, 211, 153, 0.1);
      border: 2px solid rgba(52, 211, 153, 0.3);
      border-radius: 8px;
    }

    @media (max-width:768px){
      body{padding:12px;gap:0.5rem}.section-card{padding:12px;border-radius:0}
      #uploadModal .modal-content { width: 95%; padding: 16px; }
      #imagePreviewArea { grid-template-columns: repeat(2, 1fr); }
      #modalImageContainer { max-width: 100%; }
    }
  </style>
</head>
<body class="text-white">

  <!-- ë¡œê·¸ì¸ ë°” (ìˆ¨ê¹€ ì²˜ë¦¬) -->
  <div id="authBar" class="w-full max-w-5xl mx-auto flex items-center justify-end gap-2 mb-2 hidden">
    <span id="userInfo" class="text-sm opacity-80"></span>
    <button id="signInBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Google ë¡œê·¸ì¸</button>
    <button id="signOutBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ íƒ€ì´í‹€ -->
  <h1 class="text-3xl font-bold text-center text-white">
    <span class="text-blue-400">ì œ2íšŒ ë„¤ì»·ë§Œí™”</span>
    <span class="text-white">ëŒ€ì „</span>
    <span class="text-red-400">!</span>
  </h1>
  
  <div id="contestTopicDisplay" class="hidden">
    ì˜¤ëŠ˜ì˜ ì œì‹œì–´: <span id="contestTopicText" class="text-white">...</span>
  </div>
  
  <button id="startContestBtn" class="mt-2 mb-4">
    ëŒ€ì „ ì‹œì‘í•˜ê¸°
  </button>


  <!-- ë§Œí™” ì—…ë¡œë“œ ë° ê°¤ëŸ¬ë¦¬ ì„¹ì…˜ -->
  <div id="comics-section" class="section-card text-left">
    
    <!-- ê´€ë¦¬ì ë²„íŠ¼ ë˜í¼ -->
    <section class="text-center mb-6 flex justify-center items-center gap-4 flex-wrap">
      <button id="showUploadModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105 hidden">
        + ë„¤ì»·ë§Œí™” ì˜¬ë¦¬ê¸°
      </button>
      
      <button id="endContestBtn" class="hidden">
        ì˜¬ë¦¬ê¸° ì¢…ë£Œ
      </button>
      
      <button id="startVotingBtn" class="hidden">
        íˆ¬í‘œ ì‹œì‘
      </button>
      
      <!-- 3. 'íˆ¬í‘œ ì¢…ë£Œ' ë²„íŠ¼ ì¶”ê°€ -->
      <button id="endVotingBtn" class="hidden">
        íˆ¬í‘œ ì¢…ë£Œ
      </button>
    </section>
    
    <!-- ë„¤ì»·ë§Œí™” ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ -->
    <section id="comic-grid"></section>
  </div>


  <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
  <div id="imageModal" class="modal">
    <div class="modal-content relative">
      <button id="closeImageModalBtn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h3 id="modalComicNickname" class="text-xl font-bold text-white text-center"></h3>
      <div id="modalComicTopic" class="hidden"></div>
      
      <div id="modalImageContainer"></div>
      <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="hidden" />
    </div>
  </div>

  <!-- ìƒˆ ë§Œí™” ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4">ë„¤ì»·ë§Œí™” ì˜¬ë¦¬ê¸°</h2>
      
      <div class="mb-4">
        <label for="uploadNickname" class="block text-sm font-medium text-gray-300 mb-1">ë‹‰ë„¤ì„</label>
        <input type="text" id="uploadNickname" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="ì‘ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="mb-4">
        <label for="comicFilesInput" class="file-input-label">
          ë§Œí™” ì´ë¯¸ì§€ ì„ íƒ (ìµœëŒ€ 4ì¥)
        </label>
        <input type="file" id="comicFilesInput" multiple accept="image/*">
        <p class="text-xs text-gray-400 mt-2">íŒ: 1~4ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”. 4ì¥ì´ ë„˜ìœ¼ë©´ 4ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œë©ë‹ˆë‹¤.</p>
      </div>

      <div id="imagePreviewArea">
        <span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button id="cancelUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ì·¨ì†Œ</button>
        <button id="submitComicBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ì œì¶œ</button>
      </div>
    </div>
  </div>


  <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
  <div id="alert-modal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto">
      <p id="modal-message" class="text-white text-lg text-center font-medium"></p>
      <div class="mt-4 flex justify-center gap-4">
        <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 hidden">ì·¨ì†Œ</button>
        <button id="modal-confirm-btn" class="px-4 py-2 bg-[#424242] text-white rounded-md hover:bg-[#525252]">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ëŒ€ì „ ì‹œì‘ ëª¨ë‹¬ (ë¹„ë°€ë²ˆí˜¸) -->
  <div id="contestPasswordModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">ëŒ€ì „ ì‹œì‘</h3>
      <p class="text-gray-300 text-center mb-4">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="contestPasswordInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelPasswordBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitPasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">í™•ì¸</button>
      </div>
    </div>
  </div>
  
  <!-- ëŒ€ì „ ì‹œì‘ ëª¨ë‹¬ (ì œì‹œì–´) -->
  <div id="contestTopicModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">ì œì‹œì–´ ì„¤ì •</h3>
      <p class="text-gray-300 text-center mb-4">ì˜¤ëŠ˜ì˜ ì œì‹œì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="text" id="contestTopicInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="ì˜ˆ: ìš°ì£¼, ë¼ë©´, ...">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelTopicBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitTopicBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ì„¤ì •</button>
      </div>
    </div>
  </div>
  
  <!-- 'ì˜¬ë¦¬ê¸° ì¢…ë£Œ' ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="contestEndPasswordModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">ì—…ë¡œë“œ ì¢…ë£Œ</h3>
      <p class="text-gray-300 text-center mb-4">ì—…ë¡œë“œë¥¼ ì¢…ë£Œí•˜ê³ <br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="contestEndPasswordInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelEndPasswordBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitEndPasswordBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">ì¢…ë£Œ í™•ì¸</button>
      </div>
    </div>
  </div>
  
  <!-- 'íˆ¬í‘œ ì‹œì‘' ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="contestStartVotingPasswordModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">íˆ¬í‘œ ì‹œì‘</h3>
      <p class="text-gray-300 text-center mb-4">íˆ¬í‘œë¥¼ ì‹œì‘í•˜ë ¤ë©´<br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="contestStartVotingPasswordInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelStartVotingPasswordBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitStartVotingPasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ì‹œì‘ í™•ì¸</button>
      </div>
    </div>
  </div>
  
  <!-- 'ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°' ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="contestAdminPreviewModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°</h3>
      <p class="text-gray-300 text-center mb-4">ë§Œí™”ë¥¼ ë¯¸ë¦¬ë³´ë ¤ë©´<br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="contestAdminPreviewInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelAdminPreviewBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitAdminPreviewBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">í™•ì¸</button>
      </div>
    </div>
  </div>
  
  <!-- 4. 'íˆ¬í‘œ ì¢…ë£Œ' ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="contestEndVotingPasswordModal" class="fixed inset-0 bg-[#1a1a1a] bg-opacity-50 flex items-center justify-center hidden z-[1001]">
    <div class="bg-[#242424] rounded-lg p-6 shadow-xl max-w-sm mx-auto w-full">
      <h3 class="text-xl font-bold text-white text-center mb-4">íˆ¬í‘œ ì¢…ë£Œ</h3>
      <p class="text-gray-300 text-center mb-4">íˆ¬í‘œë¥¼ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ ì§‘ê³„í•˜ë ¤ë©´<br>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="contestEndVotingPasswordInput" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-center" placeholder="****">
      <div class="mt-4 flex justify-center gap-4">
        <button id="cancelEndVotingPasswordBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="submitEndVotingPasswordBtn" class="px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700">ê²°ê³¼ ì§‘ê³„</button>
      </div>
    </div>
  </div>


  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-[1001] flex items-center justify-center hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
      <p class="text-white mt-4 text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <!-- ===== UI ìŠ¤í¬ë¦½íŠ¸ ===== -->
  <script>
    // ImgBB API Key (ì´ë¯¸ì§€ ì—…ë¡œë“œìš©)
    const IMGBB_API_KEY = "f64175972f4e4178332db9ae8559969b";

    // ì „ì—­ ìƒíƒœ
    window.comics = [];
    window.isAuthReady = false;
    window.currentContestTopic = null;
    // 5. 'ëŒ€ì „ ìƒíƒœ' (uploading | upload_ended | voting | results)
    window.currentContestStatus = 'results'; // (ì´ˆê¸° ê¸°ë³¸ê°’)
    window.comicToPreview = null; // ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°ìš© ID ì €ì¥

    // DOM ìš”ì†Œ
    const comicGrid = document.getElementById('comic-grid');
    const imageModal = document.getElementById('imageModal');
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalComicNickname = document.getElementById('modalComicNickname');
    const modalComicTopic = document.getElementById('modalComicTopic');
    const closeImageModalBtn = document.getElementById('closeImageModalBtn');
    
    // ì—…ë¡œë“œ ëª¨ë‹¬ DOM ìš”ì†Œ
    const showUploadModalBtn = document.getElementById('showUploadModalBtn');
    const uploadModal = document.getElementById('uploadModal');
    const uploadNickname = document.getElementById('uploadNickname');
    const comicFilesInput = document.getElementById('comicFilesInput');
    const imagePreviewArea = document.getElementById('imagePreviewArea');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const submitComicBtn = document.getElementById('submitComicBtn');

    // ì•Œë¦¼/í™•ì¸ ëª¨ë‹¬ ë²„íŠ¼
    const alertModal = document.getElementById('alert-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // 'ëŒ€ì „ ì‹œì‘' DOM ìš”ì†Œ
    const startContestBtn = document.getElementById('startContestBtn');
    const contestTopicDisplay = document.getElementById('contestTopicDisplay');
    const contestTopicText = document.getElementById('contestTopicText');
    const contestPasswordModal = document.getElementById('contestPasswordModal');
    const contestPasswordInput = document.getElementById('contestPasswordInput');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const submitPasswordBtn = document.getElementById('submitPasswordBtn');
    const contestTopicModal = document.getElementById('contestTopicModal');
    const contestTopicInput = document.getElementById('contestTopicInput');
    const cancelTopicBtn = document.getElementById('cancelTopicBtn');
    const submitTopicBtn = document.getElementById('submitTopicBtn');
    
    // 'ì˜¬ë¦¬ê¸° ì¢…ë£Œ' DOM ìš”ì†Œ
    const endContestBtn = document.getElementById('endContestBtn');
    const contestEndPasswordModal = document.getElementById('contestEndPasswordModal');
    const contestEndPasswordInput = document.getElementById('contestEndPasswordInput');
    const cancelEndPasswordBtn = document.getElementById('cancelEndPasswordBtn');
    const submitEndPasswordBtn = document.getElementById('submitEndPasswordBtn');
    
    // 'íˆ¬í‘œ ì‹œì‘' DOM ìš”ì†Œ
    const startVotingBtn = document.getElementById('startVotingBtn');
    const contestStartVotingPasswordModal = document.getElementById('contestStartVotingPasswordModal');
    const contestStartVotingPasswordInput = document.getElementById('contestStartVotingPasswordInput');
    const cancelStartVotingPasswordBtn = document.getElementById('cancelStartVotingPasswordBtn');
    const submitStartVotingPasswordBtn = document.getElementById('submitStartVotingPasswordBtn');
    
    // 'ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°' DOM ìš”ì†Œ
    const contestAdminPreviewModal = document.getElementById('contestAdminPreviewModal');
    const contestAdminPreviewInput = document.getElementById('contestAdminPreviewInput');
    const cancelAdminPreviewBtn = document.getElementById('cancelAdminPreviewBtn');
    const submitAdminPreviewBtn = document.getElementById('submitAdminPreviewBtn');
    
    // 6. 'íˆ¬í‘œ ì¢…ë£Œ' DOM ìš”ì†Œ
    const endVotingBtn = document.getElementById('endVotingBtn');
    const contestEndVotingPasswordModal = document.getElementById('contestEndVotingPasswordModal');
    const contestEndVotingPasswordInput = document.getElementById('contestEndVotingPasswordInput');
    const cancelEndVotingPasswordBtn = document.getElementById('cancelEndVotingPasswordBtn');
    const submitEndVotingPasswordBtn = document.getElementById('submitEndVotingPasswordBtn');


    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    const showFeedbackMessage = (message) => {
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);color:#fff;padding:16px 20px;border-radius:10px;z-index:2000;max-width:90%";
      document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
    };
    
    const showAlert = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.add('hidden');
      modalConfirmBtn.textContent = 'í™•ì¸';
      alertModal.classList.remove('hidden');
      
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
      });
    };

    const showConfirm = (msg) => {
      modalMessage.textContent = msg;
      modalCancelBtn.classList.remove('hidden');
      modalConfirmBtn.textContent = 'ì‚­ì œ';
      alertModal.classList.remove('hidden');
      
      return new Promise((resolve) => {
        modalConfirmBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(true);
        };
        modalCancelBtn.onclick = () => {
          alertModal.classList.add('hidden');
          resolve(false);
        };
      });
    };
    
    const openComicViewerModal = (comic) => {
      if (!comic || !comic.images) return;
      
      modalComicNickname.textContent = comic.uploaderName || 'ìµëª… ì‘ê°€';
      
      if (comic.contestTopic) {
        modalComicTopic.textContent = `ì œì‹œì–´: ${comic.contestTopic}`;
        modalComicTopic.classList.remove('hidden');
      } else {
        modalComicTopic.classList.add('hidden');
      }
      
      modalImageContainer.innerHTML = '';
      
      comic.images.forEach(imgData => {
        const img = document.createElement('img');
        img.src = imgData.imageUrl;
        img.alt = "ë„¤ì»·ë§Œí™” ì´ë¯¸ì§€";
        img.loading = "lazy";
        modalImageContainer.appendChild(img);
      });
      
      imageModal.style.display='flex';
    };
    const closeImageModal = () => { imageModal.style.display = 'none'; };

    const openUploadModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      uploadNickname.value = window.auth?.currentUser?.displayName || '';
      comicFilesInput.value = '';
      imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>';
      uploadModal.style.display = 'flex';
    };
    const closeUploadModal = () => {
      uploadModal.style.display = 'none';
    };

    const handleFilePreview = () => {
      imagePreviewArea.innerHTML = '';
      const files = comicFilesInput.files;
      
      if (files.length === 0) {
        imagePreviewArea.innerHTML = '<span class="text-gray-500 text-sm self-center justify-self-center col-span-2">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>';
        return;
      }
      
      const filesToShow = Array.from(files).slice(0, 4);
      
      filesToShow.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          imagePreviewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    };

    // 'ëŒ€ì „ ì‹œì‘' ëª¨ë‹¬ í•¨ìˆ˜
    const showPasswordModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      contestPasswordInput.value = '';
      contestPasswordModal.classList.remove('hidden');
      contestPasswordInput.focus();
    };
    
    const checkContestPassword = () => {
      const pass = contestPasswordInput.value;
      if (pass === '1234') {
        contestPasswordModal.classList.add('hidden');
        contestTopicInput.value = '';
        contestTopicModal.classList.remove('hidden');
        contestTopicInput.focus();
      } else {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    };
    
    const setContestTopic = () => {
      const topic = contestTopicInput.value.trim();
      if (!topic) {
        showAlert('ì œì‹œì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      if (window.saveContestTopicToDb) {
        window.saveContestTopicToDb(topic);
      }
      
      contestTopicModal.classList.add('hidden');
    };
    
    // 'ì˜¬ë¦¬ê¸° ì¢…ë£Œ' ëª¨ë‹¬ í•¨ìˆ˜
    const showEndPasswordModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      contestEndPasswordInput.value = '';
      contestEndPasswordModal.classList.remove('hidden');
      contestEndPasswordInput.focus();
    };
    
    const checkEndContestPassword = () => {
      const pass = contestEndPasswordInput.value;
      if (pass === '1234') {
        if (window.endContestUploadingPhase) {
          window.endContestUploadingPhase();
          contestEndPasswordModal.classList.add('hidden');
        }
      } else {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    };
    
    // 'íˆ¬í‘œ ì‹œì‘' ëª¨ë‹¬ í•¨ìˆ˜
    const showStartVotingPasswordModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      contestStartVotingPasswordInput.value = '';
      contestStartVotingPasswordModal.classList.remove('hidden');
      contestStartVotingPasswordInput.focus();
    };
    
    const checkStartVotingPassword = () => {
      const pass = contestStartVotingPasswordInput.value;
      if (pass === '1234') {
        if (window.startVotingPhase) {
          window.startVotingPhase();
          contestStartVotingPasswordModal.classList.add('hidden');
        }
      } else {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    };
    
    // 'ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°' ëª¨ë‹¬ í•¨ìˆ˜
    const showAdminPreviewModal = (comicId) => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      window.comicToPreview = comicId; // ë¯¸ë¦¬ ë³¼ comicId ì €ì¥
      contestAdminPreviewInput.value = '';
      contestAdminPreviewModal.classList.remove('hidden');
      contestAdminPreviewInput.focus();
    };
    
    const checkAdminPreviewPassword = () => {
      const pass = contestAdminPreviewInput.value;
      if (pass === '1234') {
        contestAdminPreviewModal.classList.add('hidden');
        if (window.comicToPreview) {
          const comic = window.comics.find(c => c.id === window.comicToPreview);
          if (comic) {
            openComicViewerModal(comic);
          }
          window.comicToPreview = null; // ID ì´ˆê¸°í™”
        }
      } else {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    };
    
    // 7. 'íˆ¬í‘œ ì¢…ë£Œ' ëª¨ë‹¬ í•¨ìˆ˜
    const showEndVotingPasswordModal = () => {
      if (!window.ensureLogin || !window.ensureLogin()) return;
      contestEndVotingPasswordInput.value = '';
      contestEndVotingPasswordModal.classList.remove('hidden');
      contestEndVotingPasswordInput.focus();
    };
    
    const checkEndVotingPassword = () => {
      const pass = contestEndVotingPasswordInput.value;
      if (pass === '1234') {
        if (window.endVotingPhase) {
          window.endVotingPhase();
          contestEndVotingPasswordModal.classList.add('hidden');
        }
      } else {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    };
    
    
    // 'ëŒ€ì „ ìƒíƒœ' UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
    const handleTopicSet = (topic, status) => {
      // 8. 'ëŒ€ì „ ìƒíƒœ' 4ë‹¨ê³„ë¡œ í™•ì¥
      window.currentContestStatus = status || 'results'; // (DBì— status ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
      
      // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸° ìˆ¨ê¹€
      startContestBtn.classList.add('hidden');
      showUploadModalBtn.classList.add('hidden');
      endContestBtn.classList.add('hidden');
      startVotingBtn.classList.add('hidden');
      endVotingBtn.classList.add('hidden'); // 'íˆ¬í‘œ ì¢…ë£Œ' ë²„íŠ¼
      
      if (topic) {
        window.currentContestTopic = topic;
        contestTopicText.textContent = topic;
        contestTopicDisplay.classList.remove('hidden');
      } else {
        window.currentContestTopic = null;
        contestTopicDisplay.classList.add('hidden');
      }

      // 9. 4ë‹¨ê³„ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ
      switch (window.currentContestStatus) {
        case 'uploading':
          // ì—…ë¡œë“œ ì¤‘: 'ì˜¬ë¦¬ê¸°' + 'ì˜¬ë¦¬ê¸° ì¢…ë£Œ' ë²„íŠ¼ í‘œì‹œ
          showUploadModalBtn.classList.remove('hidden');
          endContestBtn.classList.remove('hidden');
          break;
        case 'upload_ended':
          // ì—…ë¡œë“œ ì¢…ë£Œ: 'íˆ¬í‘œ ì‹œì‘' ë²„íŠ¼ í‘œì‹œ
          startVotingBtn.classList.remove('hidden');
          break;
        case 'voting':
          // íˆ¬í‘œ ì¤‘: 'íˆ¬í‘œ ì¢…ë£Œ' ë²„íŠ¼ í‘œì‹œ
          endVotingBtn.classList.remove('hidden');
          break;
        case 'results':
          // ê²°ê³¼ ë°œí‘œ: ëª¨ë“  ê´€ë¦¬ ë²„íŠ¼ ìˆ¨ê¹€
          // (ë§Œì•½ ë‹¤ì‹œ ì‹œì‘í•˜ê²Œ í•˜ë ¤ë©´ 'ëŒ€ì „ ì‹œì‘' ë²„íŠ¼ì„ í‘œì‹œ)
          if (!topic) { // í† í”½ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ (ìµœì´ˆ ìƒíƒœ)
             startContestBtn.classList.remove('hidden');
          }
          break;
        default:
          // (ìƒíƒœê°€ ì—†ê±°ë‚˜ ì•Œ ìˆ˜ ì—†ìŒ): 'ëŒ€ì „ ì‹œì‘' ë²„íŠ¼ í‘œì‹œ
          startContestBtn.classList.remove('hidden');
      }
      
      // 'ëŒ€ì „ ìƒíƒœ'ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ê°¤ëŸ¬ë¦¬ ìƒˆë¡œê³ ì¹¨
      if(typeof renderComics === 'function') {
        renderComics();
      }
    };


    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
    const attachEventListeners=()=>{
      closeImageModalBtn.addEventListener('click', closeImageModal);
      imageModal.addEventListener('click',(e)=>{ 
        if(e.target === imageModal) closeImageModal(); 
      }); 
      
      showUploadModalBtn.addEventListener('click', openUploadModal);
      cancelUploadBtn.addEventListener('click', closeUploadModal);
      submitComicBtn.addEventListener('click', () => {
        if (window.handleSubmitComic) window.handleSubmitComic();
      });
      comicFilesInput.addEventListener('change', handleFilePreview);
      
      // 'ëŒ€ì „ ì‹œì‘' ì´ë²¤íŠ¸
      startContestBtn.addEventListener('click', showPasswordModal);
      cancelPasswordBtn.addEventListener('click', () => contestPasswordModal.classList.add('hidden'));
      submitPasswordBtn.addEventListener('click', checkContestPassword);
      cancelTopicBtn.addEventListener('click', () => contestTopicModal.classList.add('hidden'));
      submitTopicBtn.addEventListener('click', setContestTopic);
      contestPasswordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitPasswordBtn.click(); });
      contestTopicInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitTopicBtn.click(); });
      
      // 'ì˜¬ë¦¬ê¸° ì¢…ë£Œ' ì´ë²¤íŠ¸
      endContestBtn.addEventListener('click', showEndPasswordModal);
      cancelEndPasswordBtn.addEventListener('click', () => contestEndPasswordModal.classList.add('hidden'));
      submitEndPasswordBtn.addEventListener('click', checkEndContestPassword);
      contestEndPasswordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitEndPasswordBtn.click(); });
      
      // 'íˆ¬í‘œ ì‹œì‘' ì´ë²¤íŠ¸
      startVotingBtn.addEventListener('click', showStartVotingPasswordModal);
      cancelStartVotingPasswordBtn.addEventListener('click', () => contestStartVotingPasswordModal.classList.add('hidden'));
      submitStartVotingPasswordBtn.addEventListener('click', checkStartVotingPassword);
      contestStartVotingPasswordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitStartVotingPasswordBtn.click(); });
      
      // 'ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸°' ì´ë²¤íŠ¸
      cancelAdminPreviewBtn.addEventListener('click', () => contestAdminPreviewModal.classList.add('hidden'));
      submitAdminPreviewBtn.addEventListener('click', checkAdminPreviewPassword);
      contestAdminPreviewInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitAdminPreviewBtn.click(); });
      
      // 10. 'íˆ¬í‘œ ì¢…ë£Œ' ì´ë²¤íŠ¸
      endVotingBtn.addEventListener('click', showEndVotingPasswordModal);
      cancelEndVotingPasswordBtn.addEventListener('click', () => contestEndVotingPasswordModal.classList.add('hidden'));
      submitEndVotingPasswordBtn.addEventListener('click', checkEndVotingPassword);
      contestEndVotingPasswordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') submitEndVotingPasswordBtn.click(); });
    };

    // ë„¤ì»·ë§Œí™” ê°¤ëŸ¬ë¦¬ ë Œë”ë§ (ëŒ€í­ ìˆ˜ì •ë¨)
    const renderComics = () => {
      if (!comicGrid) return;
      comicGrid.innerHTML = '';
      
      // 11. í˜„ì¬ ëŒ€ì „ ìƒíƒœ í™•ì¸
      const status = window.currentContestStatus;
      const isUploading = (status === 'uploading' || status === 'upload_ended');
      const isVoting = (status === 'voting');
      const isResults = (status === 'results');

      let sortedComics = [...(window.comics || [])];
      
      // 12. 'ê²°ê³¼' ìƒíƒœì¼ ë•Œë§Œ 'ë”°ë´‰' ìˆœìœ¼ë¡œ ì •ë ¬
      if (isResults) {
        sortedComics.sort((a, b) => {
          const likesA = Object.keys(a.likes || {}).length;
          const likesB = Object.keys(b.likes || {}).length;
          return likesB - likesA; // 'ë”°ë´‰' ë§ì€ ìˆœ
        });
      }
      // (ê·¸ ì™¸ì—ëŠ” DBì—ì„œ ê°€ì ¸ì˜¨ ê¸°ë³¸ ìˆœì„œ = ìµœì‹ ìˆœ)

      // 13. ë“±ìˆ˜ ê³„ì‚° (ê²°ê³¼ ìƒíƒœì¼ ë•Œë§Œ)
      let ranks = {}; // { comicId: 1, comicId_B: 2, ... }
      if (isResults) {
        let currentRank = 0;
        let lastLikeCount = -1;
        let tiedCount = 1;
        
        sortedComics.forEach((comic, index) => {
          const likeCount = Object.keys(comic.likes || {}).length;
          
          if (likeCount !== lastLikeCount) {
            currentRank += tiedCount;
            tiedCount = 1;
            lastLikeCount = likeCount;
          } else {
            tiedCount++;
          }
          
          if (currentRank <= 3 && likeCount > 0) {
            ranks[comic.id] = currentRank;
          }
        });
      }

      sortedComics.forEach(d => {
        const uploaderName = d.uploaderName || 'ìµëª…';
        const likeMap = d.likes || {};
        const likeCount = Object.keys(likeMap).length;
        const imageCount = d.images?.length || 0;
        
        const currentUserId = window.auth?.currentUser?.uid;
        const userHasLiked = currentUserId && likeMap[currentUserId] === true;
        
        // 14. ë“±ìˆ˜ í™•ì¸
        const rank = ranks[d.id] || 0;
        let rankClass = '';
        let rankMedal = '';
        if (rank === 1) { rankClass = 'rank-1'; rankMedal = 'ğŸ¥‡'; }
        else if (rank === 2) { rankClass = 'rank-2'; rankMedal = 'ğŸ¥ˆ'; }
        else if (rank === 3) { rankClass = 'rank-3'; rankMedal = 'ğŸ¥‰'; }

        // 15. ë¹„í™œì„±í™” ìƒíƒœ ê²°ì •
        // 'ì—…ë¡œë“œ ì¤‘/ì¢…ë£Œ' ìƒíƒœë©´ ë¹„í™œì„±í™”, 'íˆ¬í‘œ ì¤‘'/'ê²°ê³¼' ìƒíƒœë©´ í™œì„±í™”
        const isDisabled = isUploading;
        // 'ë”°ë´‰' ë²„íŠ¼ ë¹„í™œì„±í™” (ì—…ë¡œë“œ ì¤‘ì´ê±°ë‚˜, ê²°ê³¼ ë°œí‘œê°€ ë‚¬ê±°ë‚˜)
        const isLikeDisabled = isUploading || isResults;

        const card = document.createElement('div');
        card.className = `comic-card relative group ${isDisabled ? 'disabled' : ''} ${rankClass}`;
        card.dataset.id = d.id;
        
        card.innerHTML = `
          ${rankMedal ? `<div class="rank-medal">${rankMedal}</div>` : ''}
          <div class="content" data-action="view">
            <span class="nickname-display">${uploaderName}</span>
            <span class="sub-text">${imageCount}ì»· ë§Œí™”</span>
            <!-- ì¹´ë“œì—ì„œ ì œì‹œì–´ ì œê±°ë¨ -->
          </div>
          <div class="info-footer">
            <div class="like-section">
              <!-- 16. 'ê²°ê³¼' ìƒíƒœì¼ ë•Œë„ 'ë”°ë´‰' ë¹„í™œì„±í™” -->
              <button class="like-btn ${userHasLiked ? 'liked' : ''} ${isLikeDisabled ? 'disabled' : ''}" data-id="${d.id}" data-action="like">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 11-3 0v-6zM6 10.333v5.167c0 .83.682 1.5 1.502 1.5h6.666A1.5 1.5 0 0015.5 15.5V8.167A1.5 1.5 0 0014 6.667h-2.167A2.5 2.5 0 009.5 4.5V3.083A1.5 1.5 0 008 1.583 1.5 1.5 0 006.5 3v7.333z" />
                </svg>
                <span>ë”°ë´‰!</span>
              </button>
              <span class="like-count">${likeCount} ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span>
            </div>
          </div>
          
          <!-- 17. 'ê²°ê³¼' ìƒíƒœì¼ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ (ê´€ë¦¬ ìš©ì´) -->
          ${(currentUserId === d.uploaderId && (isResults || isVoting)) ? `
          <button class="absolute top-2 right-2 bg-[#424242] text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20" data-id="${d.id}" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          ` : ''}
        `;
        comicGrid.appendChild(card);
      });
      
      comicGrid.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = async (e) => { 
          e.stopPropagation(); 
          const id = e.currentTarget.dataset.id;
          const action = e.currentTarget.dataset.action;
          
          // 18. 'ë”°ë´‰' ë¹„í™œì„±í™” ë¡œì§
          if (action === 'like' && (isUploading || isResults)) {
            e.preventDefault();
            if (isUploading) showAlert('ì•„ì§ì€ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íˆ¬í‘œ ê¸°ê°„ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!');
            if (isResults) showAlert('íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
          }
          
          // 19. ì‚­ì œ ë¹„í™œì„±í™” ë¡œì§
          if (action === 'delete' && isUploading) {
             e.preventDefault();
             showAlert('ì—…ë¡œë“œ ê¸°ê°„ ì¤‘ì—ëŠ” ë§Œí™”ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
             return;
          }

          if (action === 'delete') {
            if (window.deleteComic) await window.deleteComic(id);
          } else if (action === 'like') {
            if (window.toggleLike) await window.toggleLike(id);
          }
        };
      });

      comicGrid.querySelectorAll('.comic-card').forEach(card => {
        card.onclick = (e) => {
          if (e.target.closest('button[data-action]')) return;
          
          const id = card.dataset.id;
          
          // 20. 'ì—…ë¡œë“œ ì¤‘/ì¢…ë£Œ' ìƒíƒœì¼ ë•Œ
          if (isUploading) {
            e.stopPropagation();
            // ê´€ë¦¬ì ë¯¸ë¦¬ë³´ê¸° ë¹„ë°€ë²ˆí˜¸ ë¬»ê¸°
            showAdminPreviewModal(id);
            return;
          }
          
          // 'íˆ¬í‘œ ì¤‘' ë˜ëŠ” 'ê²°ê³¼' ìƒíƒœì¼ ë•Œ (ì •ìƒ ì—´ëŒ)
          const comic = window.comics.find(c => c.id === id);
          if (comic) {
            openComicViewerModal(comic);
          }
        };
      });
    };

    (function init(){ 
      attachEventListeners(); 
    })();
    
  </script>

  <!-- ===== Firebase & ë™ê¸°í™” ===== -->
  <script type="module">
    // í™˜ê²½ ë³€ìˆ˜ì—ì„œ Firebase ì„¤ì • ì½ê¸°
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase ì•± ì´ˆê¸°í™”
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signInAnonymously, 
      signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, deleteDoc, collection, onSnapshot, 
      addDoc, updateDoc, serverTimestamp, query, orderBy, 
      limit, deleteField, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; // ì˜¤ë¥˜ ìˆ˜ì •: ì œê±°ë¨

    // ë””ë²„ê·¸ ë¡œê·¸ ë¹„í™œì„±í™”
    // setLogLevel('Debug'); // ì˜¤ë¥˜ ìˆ˜ì •: ì œê±°ë¨
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    window.auth = auth;

    const loadingOverlay=document.getElementById('loading-overlay');

    const comicsCollectionPath = `artifacts/${appId}/public/data/comics`;
    const configCollectionPath = `artifacts/${appId}/public/data/config`;
    
    window.cloudRefs = () => {
      return {
        comicsCol: collection(db, comicsCollectionPath),
        configDoc: doc(db, configCollectionPath, "currentTopic") // 'currentTopic' ë¬¸ì„œ ì‚¬ìš©
      };
    };

    window.ensureLogin=()=>{
      if(!window.isAuthReady){ showAlert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.'); return false; }
      if(!auth.currentUser){ showAlert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.'); return false; }
      if(auth.currentUser.isAnonymous) {
        showAlert('ì½˜í…ì¸ ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê´€ë¦¬í•˜ë ¤ë©´ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬ ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸ë¨)');
        return false;
      }
      return true;
    };

    /**
     * ImgBBì— ì´ë¯¸ì§€ í•˜ë‚˜ë¥¼ ì—…ë¡œë“œí•˜ê³  ê²°ê³¼ URL (ì´ë¯¸ì§€/ì‚­ì œ)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    const uploadToImgBB = async (fileOrUrl) => {
      const form = new FormData();
      form.append('image', fileOrUrl);
      
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: form });
      const json = await res.json();
      
      if (!json.success) {
        throw new Error(json?.error?.message || 'ImgBB ì—…ë¡œë“œ ì‹¤íŒ¨');
      }
      
      return {
        imageUrl: json.data?.url || json.data?.display_url,
        deleteUrl: json.data?.delete_url || null
      };
    };

    // ìƒˆ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    window.handleSubmitComic = async () => {
      if (!ensureLogin()) return;
      
      if (!window.currentContestTopic) {
        showAlert('í˜„ì¬ ì„¤ì •ëœ ì œì‹œì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì „ì„ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (window.currentContestStatus !== 'uploading') {
        showAlert('ì§€ê¸ˆì€ ì—…ë¡œë“œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');
        return;
      }

      const nickname = document.getElementById('uploadNickname').value.trim();
      const files = document.getElementById('comicFilesInput').files;
      
      if (!nickname) {
        showAlert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (files.length === 0) {
        showAlert('í•˜ë‚˜ ì´ìƒì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const filesToUpload = Array.from(files).slice(0, 4);

      loadingOverlay.classList.remove('hidden');
      showFeedbackMessage(`ë§Œí™” ${filesToUpload.length}ì¥ ì—…ë¡œë“œ ì¤‘...`);

      try {
        const { comicsCol } = cloudRefs();
        
        const uploadPromises = filesToUpload.map(file => uploadToImgBB(file));
        const uploadedImagesData = await Promise.all(uploadPromises);
        
        await addDoc(comicsCol, {
          images: uploadedImagesData,
          uploaderId: auth.currentUser.uid,
          uploaderName: nickname,
          uploaderDisplayName: auth.currentUser.displayName || 'ìµëª…',
          timestamp: serverTimestamp(),
          likes: {},
          contestTopic: window.currentContestTopic
        });

        loadingOverlay.classList.add('hidden');
        showFeedbackMessage('ë§Œí™”ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        if(typeof closeUploadModal === 'function') closeUploadModal();

      } catch (err) {
        loadingOverlay.classList.add('hidden');
        showAlert('ë§Œí™” ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || 'ì˜¤ë¥˜'));
      }
    };
    
    // ë„¤ì»·ë§Œí™” ì‚­ì œ
    window.deleteComic = async (id)=>{
      if(!ensureLogin()) return;
      
      if (window.currentContestStatus === 'uploading' || window.currentContestStatus === 'upload_ended') {
         showAlert('ì—…ë¡œë“œ ê¸°ê°„ ì¤‘ì—ëŠ” ë§Œí™”ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
         return;
      }
      
      try{
        const comic = (window.comics||[]).find(d=>d.id===id); 
        if(!comic) throw new Error('ë§Œí™” í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        
        if(comic.uploaderId !== auth.currentUser.uid) {
          showAlert('ìì‹ ì´ ì˜¬ë¦° ë§Œí™”ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }

        if (!(await showConfirm('ì •ë§ë¡œ ì´ ë§Œí™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))) return;

        const { comicsCol } = cloudRefs();
        
        // ImgBB ì‚­ì œ (CORS ì˜¤ë¥˜ë¡œ ì¸í•´ ì£¼ì„ ì²˜ë¦¬)
        /*
        if(comic.images && Array.isArray(comic.images)){ 
          const deletePromises = comic.images
            .filter(img => img.deleteUrl)
            .map(img => fetch(img.deleteUrl, { method: 'GET' }).catch(e => console.error("ImgBB ì‚­ì œ ì˜¤ë¥˜:", e)));
          await Promise.allSettled(deletePromises);
        }
        */
        
        await deleteDoc(doc(comicsCol, id));
        showFeedbackMessage('ë§Œí™”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

      }catch(e){
        showAlert('ë§Œí™” ì‚­ì œ ì¤‘ ì˜¤ë¥˜: '+(e?.message||'unknown'));
      }
    };

    // 'ë”°ë´‰' (ì¢‹ì•„ìš”) í† ê¸€ ê¸°ëŠ¥
    window.toggleLike = async (id) => {
      if(!window.isAuthReady){ showAlert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.'); return false; }
      if(!auth.currentUser){ showAlert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.'); return false; }
      
      if (window.currentContestStatus !== 'voting') {
         if (window.currentContestStatus === 'results') {
           showAlert('íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
         } else {
           showAlert('ì•„ì§ì€ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íˆ¬í‘œ ê¸°ê°„ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!');
         }
         return;
      }

      const userId = auth.currentUser.uid;
      const comicRef = doc(db, comicsCollectionPath, id);
      
      const comic = window.comics.find(c => c.id === id);
      if (!comic) return;

      const userHasLiked = (comic.likes || {})[userId] === true;
      
      try {
        if (userHasLiked) {
          await updateDoc(comicRef, { [`likes.${userId}`]: deleteField() });
        } else {
          await updateDoc(comicRef, { [`likes.${userId}`]: true });
        }
      } catch (e) {
        console.error("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showAlert("ì¢‹ì•„ìš” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };
    
    // 'ì œì‹œì–´' DB ì €ì¥ í•¨ìˆ˜
    window.saveContestTopicToDb = async (topic) => {
      if (!ensureLogin()) return;
      
      const { configDoc } = cloudRefs();
      try {
        await setDoc(configDoc, {
          name: topic,
          status: "uploading", // ìƒíƒœ: 'ì—…ë¡œë“œ ì¤‘'
          setBy: auth.currentUser.displayName || auth.currentUser.uid,
          updatedAt: serverTimestamp()
        });
        showFeedbackMessage('ìƒˆë¡œìš´ ì œì‹œì–´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (e) {
        console.error("ì œì‹œì–´ ì €ì¥ ì˜¤ë¥˜:", e);
        showAlert("ì œì‹œì–´ë¥¼ ì„¤ì •í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };
    
    // 'ì—…ë¡œë“œ ì¢…ë£Œ' DB ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    window.endContestUploadingPhase = async () => {
      if (!ensureLogin()) return; 
      const { configDoc } = cloudRefs();
      try {
        await setDoc(configDoc, {
          status: "upload_ended", // ìƒíƒœ: 'ì—…ë¡œë“œ ì¢…ë£Œ'
          updatedAt: serverTimestamp()
        }, { merge: true });
        
        showFeedbackMessage('ì—…ë¡œë“œ ë‹¨ê³„ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error("ëŒ€ì „ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showAlert("ëŒ€ì „ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };
    
    // 'íˆ¬í‘œ ì‹œì‘' DB ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    window.startVotingPhase = async () => {
      if (!ensureLogin()) return; 
      const { configDoc } = cloudRefs();
      try {
        await setDoc(configDoc, {
          status: "voting", // ìƒíƒœ: 'íˆ¬í‘œ ì¤‘'
          updatedAt: serverTimestamp()
        }, { merge: true });
        
        showFeedbackMessage('íˆ¬í‘œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (e) {
        console.error("ëŒ€ì „ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showAlert("ëŒ€ì „ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };
    
    // 21. 'íˆ¬í‘œ ì¢…ë£Œ' DB ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    window.endVotingPhase = async () => {
      if (!ensureLogin()) return; 
      const { configDoc } = cloudRefs();
      try {
        await setDoc(configDoc, {
          status: "results", // ìƒíƒœ: 'ê²°ê³¼'
          updatedAt: serverTimestamp()
        }, { merge: true });
        
        showFeedbackMessage('íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤!');
      } catch (e) {
        console.error("ëŒ€ì „ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
        showAlert("ëŒ€ì „ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    // ===== ì‹¤ì‹œê°„ ë™ê¸°í™” =====
    window.__unsubs=[];
    async function setupRealtimeSync(userId){
      const { comicsCol, configDoc } = cloudRefs();
      
      window.__unsubs.forEach(fn=>{ try{ fn(); }catch(_){} }); 
      window.__unsubs=[];

      // 1. ë§Œí™” ê°¤ëŸ¬ë¦¬ êµ¬ë…
      const q = query(comicsCol, orderBy("timestamp", "desc"), limit(100));
      const unsubComics = onSnapshot(q, (snap) => { 
          window.comics = snap.docs.map(d=>({id:d.id,...d.data()})); 
          if(typeof renderComics === 'function') renderComics(); 
      }, (error) => {
          console.error("Comics snapshot error: ", error);
          if (error.code === 'permission-denied') {
            showAlert("ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”. ('comics' ì»¬ë ‰ì…˜ì— ëŒ€í•œ 'read: true' ì„¤ì • í•„ìš”)");
          }
      });
      window.__unsubs.push(unsubComics);

      // 2. í˜„ì¬ 'ëŒ€ì „ ìƒíƒœ' ë° 'ì œì‹œì–´' êµ¬ë…
      const unsubConfig = onSnapshot(configDoc, (docSnap) => {
        let currentTopic = null;
        let currentStatus = 'results'; // ê¸°ë³¸ê°’: ê²°ê³¼ (ì œì‹œì–´ ì—†ìœ¼ë©´)
        
        if (docSnap.exists()) {
          currentTopic = docSnap.data().name;
          currentStatus = docSnap.data().status || 'uploading'; // (í•˜ìœ„ í˜¸í™˜ì„±)
        }
        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
        if (typeof handleTopicSet === 'function') {
          handleTopicSet(currentTopic, currentStatus);
        } else {
          console.warn('handleTopicSet í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      }, (error) => {
          console.error("Config snapshot error: ", error);
          if (error.code === 'permission-denied') {
            showAlert("ì œì‹œì–´ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”. ('config/currentTopic'ì— ëŒ€í•œ 'read: true' ì„¤ì • í•„ìš”)");
          }
      });
      window.__unsubs.push(unsubConfig);
    }

    onAuthStateChanged(auth, async (user)=>{
      loadingOverlay.classList.remove('hidden'); 
      window.isAuthReady=false;
      const currentUserId = user ? user.uid : null;
      
      if(user){
        await setupRealtimeSync(currentUserId);
      } else {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
          loadingOverlay.classList.add('hidden');
          window.isAuthReady = true;
          showAlert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
        }
        return;
      }
      
      loadingOverlay.classList.add('hidden'); 
      window.isAuthReady=true;
      
      if(typeof renderComics==='function') renderComics();
    });
  </script>
</body>
</html>

